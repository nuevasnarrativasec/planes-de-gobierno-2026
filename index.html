<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planes de Gobierno 2026</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="./css/style.css?v2">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bxslider@4.2.17/dist/jquery.bxslider.min.css">
    
</head>
<body>

    <div id="header">
        <div class="ctn-header">
            <img src="./img/logo-tu-decides.jpg" alt="T√∫ Decides" width="100%" class="logo-tu-decides">
            <h1>¬øQu√© propone tu candidato?</h1>
            <h2>Decide con datos y compara los planes de gobierno 2026 - 2031</h2>
        </div>
    </div>

    <div class="main">
        <p class="bajada">
            Este especial analiza y compara lo que cada candidato ofrece en su plan de gobierno con una metodolog√≠a h√≠brida: clasificaci√≥n y extracci√≥n asistidas por IA, validadas por el equipo editorial. Podr√°s explorar por candidato o partido, contrastar propuestas por tema y revisar indicadores de coherencia, concreci√≥n y sustento. Adem√°s, incluimos chequeos puntuales y visualizaciones que muestran con claridad: √©nfasis, vac√≠os y posibles contradicciones. Informaci√≥n clara y breve para que t√∫ decidas mejor.
        </p>
        <span class="update">Actualizado al 28/10/2025</span>

        <ul class="anclas">
            <li>
                candidato/partido
            </li>
            <li>
                compara planes
            </li>
            <li>
                panorama general
            </li>
        </ul>

        <div class="box-titulo-seccion">
            <h3>¬øSab√≠as que?</h3>
            <p>Descubre de un vistazo los datos m√°s relevantes que encontramos en las propuestas</p>
            <img src="./img/icon-desliza.png" alt="" width="100%">
        </div>

        <div class="box-slider-resumen">
            <div class="slider-resumen">
                <div>
                    <div class="box-info-slider-resumen">
                        <h2 class="slide-title">La mayor densidad tem√°tica</h2>
                        <div class="slide-party">Partido Nacional<br>Manzanas Rojas</div>
                        <div class="slide-content">
                            <h3 class="slide-subtitle">El plan m√°s "denso" en propuestas</h3>
                            <p class="slide-description">M√°s propuestas por cap√≠tulo y mayor detalle por tema.</p>
                            <p class="slide-metric">M√©trica: Densidad promedio<br>1.9 propuestas/p√°gina</p>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="box-info-slider-resumen">
                        <h2 class="slide-title">Mayor alcance territorial</h2>
                        <div class="slide-party">Coalici√≥n Verde</div>
                        <div class="slide-content">
                            <h3 class="slide-subtitle">El plan con m√°s cobertura regional</h3>
                            <p class="slide-description">Propuestas espec√≠ficas para cada regi√≥n del pa√≠s.</p>
                            <p class="slide-metric">M√©trica: Cobertura territorial<br>98% de regiones</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="box-main-candidatos">
            <h3>explora por candidato o partido</h3>
            <p class="bajada-candidatos">
                Busca un candidato o partido para ver el resumen de su plan y los temas clave que aborda. Resumen asistido por IA y validado por nuestro equipo period√≠stico. Para m√°s detalle ver metodolog√≠a.
            </p>
            <div class="container">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('partido')">Por partido</button>
                    <button class="tab" onclick="switchTab('candidato')">Por candidato</button>
                </div>

                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Buscar" onkeyup="filterItems()">
                        <span class="search-icon">üîç</span>
                    </div>
                </div>

                <div class="content">
                    <div class="sidebar" id="itemList">
                        <!-- Items will be loaded here -->
                    </div>

                    <div class="detail-panel" id="detailPanel">
                        <div class="empty-state">
                            Selecciona un partido o candidato para ver los detalles
                        </div>
                    </div>
                </div>
            </div>  
        </div>

        <!-- Secci√≥n de Comparador -->
        <div class="comparison-section" id="comparisonSection">
            <div class="comparison-header">
                <h2>Comparador de Planes</h2>
                <p>Elige hasta 3 planes y comp√°ralos por tema, tono y coherencia. Resumen asistido por IA y validado por nuestro equipo period√≠stico. Para m√°s detalle ver metodolog√≠a.</p>
                
                <div class="theme-selector">
                    <div class="theme-dropdown">
                        <select id="themeSelector" onchange="updateComparisonTheme()">
                            <option value="">Temas</option>
                            <option value="educacion">Educaci√≥n</option>
                            <option value="economia">Econom√≠a</option>
                            <option value="salud">Salud</option>
                            <option value="seguridad">Seguridad</option>
                            <option value="infraestructura">Infraestructura</option>
                            <option value="medio-ambiente">Medio Ambiente</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="comparison-grid" id="comparisonGrid">
                <!-- Las tarjetas de comparaci√≥n se generar√°n aqu√≠ -->
            </div>
        </div>

        <div class="box-titulo-seccion">
            <h3>panorama general</h3>
        </div>

        <div class="box-main-panorama">
            <h2>Diversidad tem√°tica</h2>
            <p>
                Diversidad tem√°tica Este √≠ndice cuenta los temas distintos que aborda un plan (educaci√≥n, salud, seguridad, etc.). Lo calculamos clasificando sus fragmentos de texto (chunks) por tem√°tica. M√°s temas = mayor cobertura, pero no implica necesariamente m√°s detalle ni mejor sustento.
            </p>

            <div class="box-flourish">
                <div class="flourish-embed flourish-chart" data-src="visualisation/25750063"><script src="https://public.flourish.studio/resources/embed.js"></script><noscript><img src="https://public.flourish.studio/visualisation/25750063/thumbnail" width="100%" alt="chart visualization" /></noscript></div>
            </div>

            <h2>Densidad discursiva</h2>
            <p>
                Densidad discursiva ¬øEn qu√© temas invierte m√°s p√°ginas un plan? La densidad muestra el porcentaje del discurso que ocupa cada tema dentro de un partido. Un mayor % no implica m√°s concreci√≥n ni mejor evidencia.
            </p>

            <!-- Secci√≥n de Densidad Discursiva -->
            <div class="density-section" id="densitySection">

                <div class="density-controls">
                    <div class="party-selector">
                        <select id="densityPartyFilter" onchange="updateDensityFilter()">
                            <option value="">Partido</option>
                        </select>
                    </div>

                    <div class="theme-slider-container">
                        <div class="theme-slider" id="themeSlider">
                            <div class="theme-segments" id="themeSegments">
                                <!-- Segmentos se generar√°n din√°micamente -->
                            </div>
                            <div class="slider-handle" id="sliderHandle"></div>
                        </div>
                        <div class="theme-labels" id="themeLabels">
                            <!-- Labels se generar√°n din√°micamente -->
                        </div>
                    </div>
                </div>

                <div class="party-list" id="partyDensityList">
                    <!-- Lista de partidos con barras se generar√° aqu√≠ -->
                </div>
            </div>
        </div>


        </div>

    </div>

    <!-- scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bxslider@4.2.17/dist/jquery.bxslider.min.js"></script>

    <!-- carrusel resumen -->
    <script>
        $(document).ready(function(){
            $(".slider-resumen").bxSlider({
                infiniteLoop: false
            });
        });
    </script>

    <!-- buscador y comparador de candidatos o partidos -->
    <script>
        // ============================================
        // CONFIGURACI√ìN: URLs de Google Spreadsheets
        // ============================================
        
        // Hoja 1: Datos generales de partidos y candidatos
        const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR_yZQbmqUse6lOcFRxBhP53YkC3CdIc36YcOE3bk-w_91-TVudDvH9uVuJoSMZwf_4bPPuq--qbHKb/pub?output=csv';
        
        // Hoja 2: Datos de comparaci√≥n por temas
        const COMPARISON_SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcgvr6YP_YLsgXS9-mJD34bBug-Qzlv8W_d3ZacfQhYcM-7u85u-U6TCl8S9rsBDVPD8Ck5mMsYNxW/pub?output=csv';
        
        // ============================================
        // Variables globales - Secci√≥n Buscador
        // ============================================
        let currentTab = 'partido';
        let allData = [];
        let filteredData = [];
        
        // ============================================
        // Variables globales - Secci√≥n Densidad Discursiva
        // ============================================
        
        // URL del archivo JSON con datos de densidad
        const DENSITY_DATA_URL = './data/densidad-data.json';
        
        const themes = [
            { id: 'educacion', name: 'EDUCACI√ìN', color: '#3B82F6' },
            { id: 'salud', name: 'SALUD', color: '#EF4444' },
            { id: 'economia', name: 'ECONOM√çA', color: '#10B981' },
            { id: 'seguridad', name: 'SEGURIDAD', color: '#F59E0B' },
            { id: 'infraestructura', name: 'INFRAESTRUCTURA', color: '#8B5CF6' },
            { id: 'medio-ambiente', name: 'MEDIO AMBIENTE', color: '#06B6D4' }
        ];
        
        let selectedThemeIndex = 1; // Por defecto: SALUD
        let densityFilteredParty = '';
        let densityData = {};

        // ============================================
        // Funciones de Densidad Discursiva
        // ============================================

        // Cargar datos de densidad desde JSON
        async function loadDensityData() {
            try {
                const response = await fetch(DENSITY_DATA_URL);
                if (!response.ok) {
                    throw new Error('Error al cargar datos de densidad');
                }
                const data = await response.json();
                
                // Convertir array a objeto indexado por ID
                densityData = {};
                data.partidos.forEach(partido => {
                    densityData[partido.id] = {
                        partido: partido.nombre,
                        logoUrl: partido.logoUrl || '',
                        temas: partido.densidad
                    };
                });
                
                console.log('üìä Datos de densidad cargados:', densityData);
                return densityData;
            } catch (error) {
                console.error('‚ùå Error cargando datos de densidad:', error);
                console.log('‚ö†Ô∏è Usando datos de ejemplo...');
                
                // Datos de ejemplo si falla la carga
                densityData = {
                    "1": {
                        partido: "Partido 1",
                        logoUrl: "",
                        temas: {
                            educacion: 15,
                            salud: 25,
                            economia: 20,
                            seguridad: 18,
                            infraestructura: 12,
                            "medio-ambiente": 10
                        }
                    },
                    "2": {
                        partido: "Partido 2",
                        logoUrl: "",
                        temas: {
                            educacion: 22,
                            salud: 28,
                            economia: 15,
                            seguridad: 10,
                            infraestructura: 15,
                            "medio-ambiente": 10
                        }
                    }
                };
                return densityData;
            }
        }

        // Inicializar slider de temas
        function initThemeSlider() {
            const segmentsContainer = document.getElementById('themeSegments');
            const labelsContainer = document.getElementById('themeLabels');
            const slider = document.getElementById('themeSlider');
            
            // Crear segmentos SIN labels dentro
            segmentsContainer.innerHTML = themes.map((theme, index) => `
                <div class="theme-segment theme-${theme.id} ${index === selectedThemeIndex ? 'active' : ''}" 
                     data-index="${index}"
                     onclick="selectTheme(${index})">
                </div>
            `).join('');
            
            // Crear labels fuera de los segmentos
            labelsContainer.innerHTML = themes.map((theme, index) => `
                <div class="theme-label-item ${index === selectedThemeIndex ? 'active' : ''}" 
                     data-index="${index}">
                    ${theme.name}
                </div>
            `).join('');
            
            // Posicionar handle en el centro del segmento
            updateSliderHandle();
            
            // Hacer el slider clickeable
            slider.addEventListener('click', (e) => {
                if (e.target.classList.contains('theme-segment') || e.target.closest('.theme-segment')) {
                    return; // Ya manejado por onclick del segmento
                }
                handleSliderDrag(e.clientX);
            });
        }

        // Manejar arrastre del slider
        function handleSliderDrag(clientX) {
            const slider = document.getElementById('themeSlider');
            const rect = slider.getBoundingClientRect();
            const x = clientX - rect.left;
            const percentage = Math.max(0, Math.min(1, x / rect.width));
            const newIndex = Math.round(percentage * (themes.length - 1));
            
            if (newIndex !== selectedThemeIndex) {
                selectTheme(newIndex);
            }
        }

        // Seleccionar tema
        function selectTheme(index) {
            selectedThemeIndex = index;
            
            // Actualizar segmentos activos y dimmed
            document.querySelectorAll('.theme-segment').forEach((seg, i) => {
                seg.classList.toggle('active', i === index);
                seg.classList.toggle('dimmed', i !== index);
            });
            
            // Actualizar labels activos
            document.querySelectorAll('.theme-label-item').forEach((label, i) => {
                label.classList.toggle('active', i === index);
            });
            
            // Actualizar handle
            updateSliderHandle();
            
            // Actualizar visualizaci√≥n
            renderDensityBars();
        }

        // Actualizar posici√≥n del handle
        function updateSliderHandle() {
            const slider = document.getElementById('themeSlider');
            const handle = document.getElementById('sliderHandle');
            const segments = document.querySelectorAll('.theme-segment');
            
            if (segments.length === 0) return;
            
            // Obtener el segmento activo
            const activeSegment = segments[selectedThemeIndex];
            const segmentRect = activeSegment.getBoundingClientRect();
            const sliderRect = slider.getBoundingClientRect();
            
            // Posicionar el handle en el centro del segmento
            const segmentCenter = segmentRect.left - sliderRect.left + (segmentRect.width / 2);
            handle.style.left = `${segmentCenter}px`;
        }

        // Renderizar barras de densidad
        function renderDensityBars() {
            const container = document.getElementById('partyDensityList');
            const selectedTheme = themes[selectedThemeIndex].id;
            
            // Filtrar partidos si hay selecci√≥n
            let partidosToShow = Object.keys(densityData);
            if (densityFilteredParty) {
                partidosToShow = partidosToShow.filter(id => id == densityFilteredParty);
            }
            
            // Crear columna de nombres
            const namesHTML = partidosToShow.map(partidoId => {
                const partido = densityData[partidoId];
                const logoHTML = partido.logoUrl 
                    ? `<img src="${partido.logoUrl}" alt="${partido.partido}" onerror="this.style.display='none';">` 
                    : 'üçé';
                const highlightClass = densityFilteredParty == partidoId ? 'highlighted' : '';
                
                return `
                    <div class="party-name-item ${highlightClass}">
                        <div class="party-density-item">
                            <div class="party-density-icon">${logoHTML}</div>
                            <div class="party-density-name">${partido.partido}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Crear columna de barras
            const barsHTML = partidosToShow.map(partidoId => {
                const partido = densityData[partidoId];
                const highlightClass = densityFilteredParty == partidoId ? 'highlighted' : '';
                
                const segmentsHTML = themes.map((theme, themeIndex) => {
                    const percentage = partido.temas[theme.id] || 0;
                    const isSelected = theme.id === selectedTheme;
                    const dimmedClass = selectedTheme ? (isSelected ? 'highlighted' : 'dimmed') : '';
                    
                    return `
                        <div class="density-segment theme-${theme.id} ${dimmedClass}" 
                             style="width: ${percentage}%"
                             data-theme="${theme.id}"
                             data-theme-index="${themeIndex}"
                             onclick="selectThemeFromBar(${themeIndex})">
                            <div class="density-tooltip">${theme.name}: ${percentage}%</div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="party-bar-item ${highlightClass}">
                        <div class="party-density-bar-container">
                            <div class="party-density-bar">
                                ${segmentsHTML}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="party-names-column">
                    ${namesHTML}
                </div>
                <div class="party-bars-column">
                    ${barsHTML}
                </div>
            `;
        }

        // Seleccionar tema desde la barra de un partido
        function selectThemeFromBar(themeIndex) {
            selectTheme(themeIndex);
            
            // Scroll suave al slider
            const slider = document.getElementById('themeSlider');
            slider.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Actualizar filtro de partido
        function updateDensityFilter() {
            densityFilteredParty = document.getElementById('densityPartyFilter').value;
            renderDensityBars();
        }

        // Poblar selector de partidos
        function populateDensityPartySelector() {
            const select = document.getElementById('densityPartyFilter');
            
            const options = Object.keys(densityData).map(partidoId => {
                const partido = densityData[partidoId];
                return `<option value="${partidoId}">${partido.partido}</option>`;
            }).join('');
            
            select.innerHTML = '<option value="">Partido</option>' + options;
        }

        // ============================================
        // Variables globales - Secci√≥n Comparador
        // ============================================
        let comparisonDataList = [];
        let selectedComparisons = [null, null, null]; // M√°ximo 3 comparaciones
        let currentComparisonTheme = '';

        // ============================================
        // Funciones del Comparador
        // ============================================

        // Cargar datos de comparaci√≥n desde Google Sheets
        async function loadComparisonData() {
            try {
                const response = await fetch(COMPARISON_SPREADSHEET_URL);
                if (!response.ok) {
                    throw new Error('Error al cargar datos de comparaci√≥n');
                }
                const csvText = await response.text();
                comparisonDataList = parseCSV(csvText);
                console.log('‚úÖ Datos de comparaci√≥n cargados:', comparisonDataList);
                console.log('üìä Total de registros:', comparisonDataList.length);
                console.log('üîë Columnas disponibles:', Object.keys(comparisonDataList[0] || {}));
                return comparisonDataList;
            } catch (error) {
                console.error('‚ùå Error cargando datos de comparaci√≥n:', error);
                alert('Error al cargar los datos de comparaci√≥n. Verifica que la URL del Google Sheet sea correcta y que est√© publicado como CSV.');
                return [];
            }
        }

        // Actualizar tema de comparaci√≥n
        function updateComparisonTheme() {
            currentComparisonTheme = document.getElementById('themeSelector').value;
            renderComparisonCards();
        }

        // Renderizar tarjetas de comparaci√≥n
        function renderComparisonCards() {
            const grid = document.getElementById('comparisonGrid');
            
            grid.innerHTML = selectedComparisons.map((item, index) => {
                if (!item) {
                    return `
                        <div class="comparison-card empty">
                            <div style="font-size: 48px; color: #ddd;">+</div>
                            <p>Selecciona un candidato o partido</p>
                            <div class="card-selector" style="width: 100%; max-width: 250px;">
                                <select onchange="addToComparison(${index}, this.value)">
                                    <option value="">Candidato o Partido</option>
                                    ${allData.map(d => `<option value="${d.id}">${d.nombre}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    `;
                }
                
                return renderComparisonCard(item, index);
            }).join('');
        }

        // Renderizar una tarjeta de comparaci√≥n con datos
        function renderComparisonCard(item, index) {
            const compData = comparisonDataList.find(c => 
                c.partidoId == item.id && c.tema === currentComparisonTheme
            );
            
            console.log('Buscando datos para:', {
                partidoId: item.id,
                tema: currentComparisonTheme,
                encontrado: compData,
                todosLosDatos: comparisonDataList
            });
            
            if (!compData && currentComparisonTheme) {
                return `
                    <div class="comparison-card">
                        <button class="remove-card" onclick="removeFromComparison(${index})">√ó</button>
                        <div class="card-profile">
                            <div class="card-avatar">
                                ${item.fotoUrl ? `<img src="${item.fotoUrl}" alt="${item.candidato}">` : '<div class="card-avatar-icon"></div><div class="card-avatar-body"></div>'}
                            </div>
                            <div class="card-name">${item.candidato}</div>
                            <div class="card-party">${item.nombre}</div>
                        </div>
                        <p style="text-align: center; color: #999; padding: 40px 20px;">
                            No hay informaci√≥n disponible para este tema
                        </p>
                    </div>
                `;
            }
            
            const avatarHTML = item.fotoUrl 
                ? `<img src="${item.fotoUrl}" alt="${item.candidato}" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'card-avatar-icon\\'></div><div class=\\'card-avatar-body\\'></div>';">` 
                : '<div class="card-avatar-icon"></div><div class="card-avatar-body"></div>';
            
            if (!currentComparisonTheme) {
                return `
                    <div class="comparison-card">
                        <button class="remove-card" onclick="removeFromComparison(${index})">√ó</button>
                        <div class="card-selector">
                            <select onchange="changeComparison(${index}, this.value)">
                                <option value="${item.id}" selected>${item.nombre}</option>
                                ${allData.filter(d => d.id != item.id).map(d => 
                                    `<option value="${d.id}">${d.nombre}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="card-profile">
                            <div class="card-avatar">${avatarHTML}</div>
                            <div class="card-name">${item.candidato || item.nombre}</div>
                            <div class="card-party">${item.nombre}</div>
                        </div>
                        <p style="text-align: center; color: #999; padding: 40px 20px;">
                            Selecciona un tema arriba para ver las propuestas
                        </p>
                    </div>
                `;
            }
            
            // Renderizar con datos completos
            const propuestasHTML = compData.propuestas ? 
                `<ul>${compData.propuestas.split('\n').filter(p => p.trim()).map(p => `<li>${p.replace(/^- /, '')}</li>`).join('')}</ul>` 
                : '<p>No hay propuestas disponibles</p>';
            
            // Parsear los factchecks individuales
            let factcheckHTML = '';
            if (compData.factcheckIntro || compData.factcheck1Propuesta) {
                const factchecks = [];
                
                // Recopilar todos los factchecks disponibles
                for (let i = 1; i <= 5; i++) {
                    const propuesta = compData[`factcheck${i}Propuesta`];
                    if (propuesta) {
                        factchecks.push({
                            propuesta: propuesta,
                            descripcion: compData[`factcheck${i}Descripcion`] || '',
                            veracidad: compData[`factcheck${i}Veracidad`] || 'doubtful',
                            explicacion: compData[`factcheck${i}Explicacion`] || ''
                        });
                    }
                }
                
                if (factchecks.length > 0) {
                    const veracidadLabels = {
                        'false': 'FALSO',
                        'true': 'VERDADERO',
                        'partially': 'PARCIALMENTE CIERTO',
                        'doubtful': 'DUDOSO'
                    };
                    
                    factcheckHTML = factchecks.map(fc => `
                        <div class="factcheck-item">
                            <div class="factcheck-proposal">${fc.propuesta}</div>
                            ${fc.descripcion ? `<div class="factcheck-description">${fc.descripcion}</div>` : ''}
                            <div class="fact-label ${fc.veracidad}">${veracidadLabels[fc.veracidad] || 'DUDOSO'}</div>
                            ${fc.explicacion ? `<div class="factcheck-explanation"><strong>Explicaci√≥n:</strong> ${fc.explicacion}</div>` : ''}
                        </div>
                    `).join('');
                }
            }
            
            return `
                <div class="comparison-card">
                    <button class="remove-card" onclick="removeFromComparison(${index})">√ó</button>
                    <div class="card-selector">
                        <select onchange="changeComparison(${index}, this.value)">
                            <option value="${item.id}" selected>${item.nombre}</option>
                            ${allData.filter(d => d.id != item.id).map(d => 
                                `<option value="${d.id}">${d.nombre}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="card-profile">
                        <div class="card-avatar">${avatarHTML}</div>
                        <div class="card-name">${item.candidato || item.nombre}</div>
                        <div class="card-party">${item.nombre}</div>
                    </div>
                    <div class="card-content">
                        <div class="content-section">
                            <h4>${currentComparisonTheme.toUpperCase()}</h4>
                            ${propuestasHTML}
                        </div>
                        ${compData.tonoDiscursivo || compData.coherencia ? `
                            <div class="discourse-tone">
                                <p><strong>Tono discursivo:</strong> ${compData.tonoDiscursivo || 'N/A'}</p>
                                <p><strong>Coherencia:</strong> ${compData.coherencia || 'N/A'}</p>
                            </div>
                        ` : ''}
                        ${factcheckHTML ? `
                            <div class="factcheck-section">
                                <h4>FACTCHECKING</h4>
                                ${compData.factcheckIntro ? `<div class="factcheck-intro">${compData.factcheckIntro}</div>` : ''}
                                ${factcheckHTML}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Agregar partido/candidato a la comparaci√≥n
        function addToComparison(index, itemId) {
            if (!itemId) return;
            
            const item = allData.find(d => d.id == itemId);
            if (item) {
                selectedComparisons[index] = item;
                renderComparisonCards();
            }
        }

        // Cambiar partido/candidato en la comparaci√≥n
        function changeComparison(index, itemId) {
            if (!itemId) return;
            
            const item = allData.find(d => d.id == itemId);
            if (item) {
                selectedComparisons[index] = item;
                renderComparisonCards();
            }
        }

        // Remover de la comparaci√≥n
        function removeFromComparison(index) {
            selectedComparisons[index] = null;
            renderComparisonCards();
        }

        // Funci√≥n mejorada de scroll a la secci√≥n de comparar
        function scrollToCompare() {
            const comparisonSection = document.getElementById('comparisonSection');
            comparisonSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Agregar al comparador desde el bot√≥n "Comparar" del detalle
        function addToCompare(item) {
            // Buscar el primer espacio vac√≠o
            const emptyIndex = selectedComparisons.findIndex(c => c === null);
            
            if (emptyIndex !== -1) {
                selectedComparisons[emptyIndex] = item;
                renderComparisonCards();
                scrollToCompare();
            } else {
                // Si ya hay 3 partidos, reemplazar el √∫ltimo
                selectedComparisons[2] = item;
                renderComparisonCards();
                scrollToCompare();
            }
        }

        // ============================================
        // Funciones del Buscador Principal
        // ============================================

        // Inicializar la aplicaci√≥n
        function init() {
            loadDataFromGoogleSheets();
            loadComparisonData();
            renderComparisonCards();
            
            // Cargar y renderizar densidad discursiva
            loadDensityData().then(() => {
                initThemeSlider();
                populateDensityPartySelector();
                renderDensityBars();
                
                // Reposicionar handle en resize
                window.addEventListener('resize', () => {
                    updateSliderHandle();
                });
            });
        }

        // Funci√≥n para parsear CSV
        function parseCSV(csv) {
            // Dividir por saltos de l√≠nea pero respetando comillas
            const lines = [];
            let currentLine = '';
            let inQuotes = false;
            
            for (let i = 0; i < csv.length; i++) {
                const char = csv[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                    currentLine += char;
                } else if (char === '\n' && !inQuotes) {
                    if (currentLine.trim()) {
                        lines.push(currentLine);
                    }
                    currentLine = '';
                } else {
                    currentLine += char;
                }
            }
            
            // Agregar la √∫ltima l√≠nea si existe
            if (currentLine.trim()) {
                lines.push(currentLine);
            }
            
            console.log('üîç Parseando CSV...');
            console.log('üìè Total de l√≠neas encontradas:', lines.length);
            
            if (lines.length === 0) {
                console.error('‚ùå No se encontraron l√≠neas en el CSV');
                return [];
            }
            
            const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/^"|"$/g, ''));
            console.log('üìã Headers encontrados:', headers);
            
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = parseCSVLine(lines[i]);
                const row = {};
                
                headers.forEach((header, index) => {
                    let value = values[index] || '';
                    // Limpiar comillas al inicio y final
                    value = value.trim().replace(/^"|"$/g, '');
                    row[header] = value;
                });
                
                // Procesar temas y descripciones (solo para la hoja principal)
                if (row.temas && row.descripcionesTemas) {
                    const temasArray = row.temas.split(',').map(t => t.trim());
                    const descripcionesArray = row.descripcionesTemas.split(',').map(d => d.trim());
                    
                    row.temas = temasArray.map((nombre, index) => ({
                        nombre: nombre,
                        descripcion: descripcionesArray[index] || ''
                    }));
                }
                
                // Debug: mostrar las primeras 3 filas parseadas
                if (i <= 3) {
                    console.log(`üìÑ Fila ${i}:`, {
                        id: row.id,
                        partido: row.partido || row.nombre,
                        tema: row.tema,
                        tonoDiscursivo: row.tonoDiscursivo,
                        coherencia: row.coherencia
                    });
                }
                
                data.push(row);
            }
            
            console.log(`‚úÖ Total de registros parseados: ${data.length}`);
            return data;
        }

        // Funci√≥n auxiliar para parsear una l√≠nea CSV (maneja comillas)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Doble comilla dentro de campo entrecomillado = comilla literal
                        current += '"';
                        i++; // Saltar la siguiente comilla
                    } else {
                        // Toggle estado de comillas (no agregar las comillas al contenido)
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // Funci√≥n para cargar datos desde Google Sheets
        async function loadDataFromGoogleSheets() {
            const itemList = document.getElementById('itemList');
            const detailPanel = document.getElementById('detailPanel');
            
            // Mostrar mensaje de carga
            itemList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Cargando datos...</div>';
            detailPanel.innerHTML = '<div class="empty-state">Cargando...</div>';

            try {
                const response = await fetch(SPREADSHEET_URL);
                
                if (!response.ok) {
                    throw new Error('Error al cargar los datos');
                }
                
                const csvText = await response.text();
                allData = parseCSV(csvText);
                filteredData = allData.filter(item => item.tipo === currentTab);
                
                console.log('Datos cargados:', allData);
                
                if (allData.length === 0) {
                    itemList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No hay datos disponibles.<br><br>Verifica que tu Google Sheet est√© correctamente configurado.</div>';
                    detailPanel.innerHTML = '<div class="empty-state">No hay datos disponibles</div>';
                } else {
                    renderItems();
                    detailPanel.innerHTML = '<div class="empty-state">Selecciona un partido o candidato para ver los detalles</div>';
                }
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                itemList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #e74c3c;">
                        <p style="font-weight: bold; margin-bottom: 10px;">Error al cargar los datos</p>
                        <p style="font-size: 13px; line-height: 1.6;">
                            Verifica que:<br>
                            1. La URL del Google Sheet sea correcta<br>
                            2. El archivo est√© publicado como CSV<br>
                            3. Tengas conexi√≥n a internet
                        </p>
                    </div>
                `;
                detailPanel.innerHTML = '<div class="empty-state">Error al cargar los datos</div>';
            }
        }

        // Cambiar entre tabs
        function switchTab(tab) {
            currentTab = tab;
            
            // Actualizar UI de tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filtrar datos seg√∫n el tab
            filterItems();
        }

        // Filtrar items por b√∫squeda
        function filterItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredData = allData.filter(item => {
                const matchesTab = item.tipo === currentTab;
                const matchesSearch = item.nombre.toLowerCase().includes(searchTerm) || 
                                     item.candidato.toLowerCase().includes(searchTerm);
                return matchesTab && matchesSearch;
            });
            
            renderItems();
        }

        // Renderizar lista de items
        function renderItems() {
            const itemList = document.getElementById('itemList');
            
            if (filteredData.length === 0) {
                itemList.innerHTML = '<div class="no-results">No se encontraron resultados</div>';
                return;
            }
            
            itemList.innerHTML = filteredData.map((item, index) => {
                const logoDisplay = item.logoUrl 
                    ? `<img src="${item.logoUrl}" alt="${item.nombre}" 
                           style="width: 100%; height: 100%; object-fit: contain; border-radius: 6px;"
                           onerror="this.style.display='none'; this.parentElement.innerHTML='üçé';">` 
                    : 'üçé';
                
                return `
                    <div class="party-item" data-id="${item.id}" data-index="${index}">
                        <div class="party-icon">${logoDisplay}</div>
                        <div class="party-name">${item.nombre}</div>
                    </div>
                `;
            }).join('');
            
            // Agregar event listeners despu√©s de renderizar
            document.querySelectorAll('.party-item').forEach(element => {
                element.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    selectItem(itemId, this);
                });
            });
        }

        // Seleccionar un item
        function selectItem(id, element) {
            const item = allData.find(i => i.id == id);
            
            if (!item) {
                console.error('Item no encontrado:', id);
                return;
            }
            
            // Actualizar UI de selecci√≥n
            document.querySelectorAll('.party-item').forEach(el => el.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            // Renderizar detalles
            renderDetails(item);
        }

        // Renderizar panel de detalles
        function renderDetails(item) {
            const detailPanel = document.getElementById('detailPanel');
            
            console.log('Renderizando detalles para:', item);
            
            // Validar que temas sea un array
            const temas = Array.isArray(item.temas) ? item.temas : [];
            
            const topicsHTML = temas.map(tema => `
                <div class="topic-tag">
                    ${tema.nombre}
                    <div class="info-icon">i</div>
                    <div class="tooltip">${tema.descripcion}</div>
                </div>
            `).join('');
            
            // Determinar si mostrar foto o avatar gen√©rico
            const avatarHTML = item.fotoUrl 
                ? `<img src="${item.fotoUrl}" alt="${item.candidato}" 
                       style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                       onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'avatar-icon\\'></div><div class=\\'avatar-body\\'></div>';">` 
                : `<div class="avatar-icon"></div><div class="avatar-body"></div>`;
            
            // Preparar el bot√≥n de descarga
            const downloadButton = item.planUrl 
                ? `<a href="${item.planUrl}" target="_blank" class="btn btn-primary" style="text-decoration: none;">Descarga el plan</a>`
                : `<button class="btn btn-primary" disabled style="opacity: 0.5; cursor: not-allowed;">Plan no disponible</button>`;
            
            detailPanel.innerHTML = `
                <div class="candidate-profile">
                    <div class="avatar">
                        ${avatarHTML}
                    </div>
                    <div class="candidate-name">${item.candidato || 'Sin informaci√≥n'}</div>
                    <div class="party-label">Partido</div>
                    <div class="candidate-info">
                        ${item.cargo || ''}<br>
                        ${item.ubicacion || ''} ${item.edad ? '- ' + item.edad : ''} ${item.estadoCivil ? '- ' + item.estadoCivil : ''} ${item.hijos ? '- ' + item.hijos : ''}
                    </div>
                </div>

                <div class="action-buttons">
                    ${downloadButton}
                    <button class="btn btn-secondary" onclick="addToCompare(${JSON.stringify(item).replace(/"/g, '&quot;')})">Comparar</button>
                </div>

                <div class="vision-section">
                    <p class="vision-text">${item.vision || 'Sin informaci√≥n de visi√≥n disponible.'}</p>
                    
                    <div class="topics-section">
                        <h3>Revisi√≥n por temas</h3>
                        <div class="topics">
                            ${topicsHTML || '<p style="color: #999;">No hay temas disponibles</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para scroll a la secci√≥n de comparar (implementar despu√©s)
        function scrollToCompare() {
            const comparisonSection = document.getElementById('comparisonSection');
            if (comparisonSection) {
                comparisonSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Iniciar la aplicaci√≥n cuando se carga la p√°gina
        window.onload = init;
    </script>
    
   
</body>
</html>