<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planes de Gobierno 2026</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="./css/style.css?v38">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bxslider@4.2.17/dist/jquery.bxslider.min.css">
    
</head>
<body>

    <div id="header">
        <div class="ctn-header">
            <img src="./img/logo-tu-decides-color.png" alt="T√∫ Decides" width="100%" class="logo-tu-decides">
            <h1>¬øQu√© propone tu candidato?</h1>
            <h2>Una gu√≠a r√°pida para comparar planes de gobierno 2026‚Äì2031.</h2>

            <div id="social">
                <button id="fb" class="sharer button" data-sharer="facebook" data-hashtag="" data-url="https://elcomercio.pe/deporte-total/goles-cristiano-ronaldo-video-anotaciones-camino-los-1000-CR7-especdis-noticia/">Facebook</button>

                <button id="wst" class="sharer button" data-sharer="whatsapp" data-title="El Comercio" data-url="https://elcomercio.pe/deporte-total/goles-cristiano-ronaldo-video-anotaciones-camino-los-1000-CR7-especdis-noticia/">Whatsapp</button>

                <button id="tw" class="sharer button" data-sharer="twitter" data-title="El Comercio" data-hashtags="" data-via='elcomercio_peru' data-url="https://elcomercio.pe/deporte-total/goles-cristiano-ronaldo-video-anotaciones-camino-los-1000-CR7-especdis-noticia/">Twitter</button>
            </div>

        </div>
        <video class="video-desktop" src="./video/portada-desktop.mp4" width="100%" loop autoplay muted playsinline></video>
        <video class="video-movil" src="./video/portada-movil.mp4" width="100%" loop autoplay muted playsinline></video>
    </div>

    <div class="main">
        <p class="bajada">
            <b>Analizamos los planes,  sintetizamos la informaci√≥n con ayuda de la IA y lo verificamos editorialmente. </b> Ahora podr√°s elegir un candidato o partido, filtrar por tema, mirar res√∫menes y detectar de un vistazo qu√© proponen, qu√© omiten y qu√© no cuadra. Disminuimos el ruido para ofrecerte m√°s claridad para que est√©s bien informado antes de emitir tu voto.
        </p>
        <span class="update">Actualizado al 28/10/2025</span>    
        
        <img src="./img/icon-click.jpg" alt="" width="100%" class="icon-click">
        <p class="elige">Elige la opci√≥n que prefieras para iniciar </p>
        <ul class="anclas">
            <li>
                Candidato o partido
            </li>
            <li>
                Compara planes
            </li>
            <li>
                Panorama general
            </li>
        </ul>            

        <!-- buscador de candidatos y partidos -->
        <div id="box-main-candidatos">
            <span class="linea-titulo-seccion"></span>
            <h3>Explora por candidato o partido</h3>
            <p class="bajada-candidatos">
                Encuentra res√∫menes claros de cada plan y accede a una versi√≥n concisa de los temas principales que aborda.
            </p>
            <div class="container">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('partido')">Partidos</button>
                    <button class="tab" onclick="switchTab('candidato')">Candidatos</button>
                </div>

                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Buscar" 
                            onkeyup="handleSearchInput(event)" 
                            onfocus="showAutocomplete()"
                            autocomplete="off">
                        <span class="search-icon">
                            <img src="../img/lupa.png" alt="" width="100%">
                        </span>
                        <div class="autocomplete-dropdown" id="autocompleteDropdown">
                            <!-- Sugerencias se generar√°n aqu√≠ -->
                        </div>
                    </div>
                </div>

                <div class="content">
                    <div class="box-indicacion">
                        <img src="./img/icon-scroll.png" alt="" width="100%">
                        <span>Has scroll para ver a los partidos y candidatos</span>
                    </div>
                    <div class="box-ctn-sidebar">
                        <div class="sidebar" id="itemList">
                            <!-- Items will be loaded here -->
                        </div>
                    </div>                    

                    <div class="detail-panel" id="detailPanel">
                        <div class="empty-state">
                            Informaci√≥n del partido o candidato elegido
                        </div>
                    </div>
                </div>
            </div>  
        </div>

        <!-- Secci√≥n de Comparador -->
        <div class="comparison-section" id="comparisonSection">
            <div class="comparison-header">
                <span class="linea-titulo-seccion"></span>
                <h2>¬øA√∫n con dudas? Compara tus principales opciones</h2>
                <p>Selecciona hasta 3 candidatos y contrasta sus propuestas por tema, tono y coherencia. Adem√°s, incluye un breve fact-checking.</p>
                
                <div class="theme-selector">
                    <div class="theme-dropdown">
                        <select id="themeSelector" onchange="updateComparisonTheme()">
                            <option value="">Temas</option>
                            <option value="agricultura">Agricultura</option>
                            <option value="cambio-climatico">Cambio clim√°tico</option>
                            <option value="cultura-turismo">Cultura y turismo</option>
                            <option value="descentralizacion">Descentralizacion</option>
                            <option value="economia">Econom√≠a</option>
                            <option value="educacion">Educaci√≥n</option>
                            <option value="energia-minera">Energ√≠a minera</option>
                            <option value="familia">Familia</option>
                            <option value="gobernanza-digital">Gobernanza digital</option>
                            <option value="infraestructura">Infraestructura</option>
                            <option value="justicia-dh">Justicia y Derechos Humanos</option>
                            <option value="ambiente">Medio Ambiente</option>
                            <option value="salud">Salud</option>
                            <option value="seguridad">Seguridad</option>
                            <option value="programas-sociales">Programas sociales</option>
                            <option value="transporte">Transporte</option>
                            <option value="vivienda">Vivienda</option>                            
                        </select>
                    </div>
                </div>
            </div>

            <div class="comparison-grid" id="comparisonGrid">
                <!-- Las tarjetas de comparaci√≥n se generar√°n aqu√≠ -->
            </div>
        </div>

        <!-- Secci√≥n de Factchecking -->
        <section class="factchecking-section" id="factcheckingSection">
            <div class="factchecking-header">
                <h2>FactChecking</h2>
                <p>¬øQu√© tan ciertas son las propuestas? Nuestro equipo eligi√≥ 3 frases clave por plan y las someti√≥ a verificaci√≥n. Aqu√≠ ver√°s qu√© se dijo, qu√© dicen los datos y c√≥mo lo comprobamos, con un veredicto al final.</p>
            </div>

            <span class="filtrar">Filtrar por:</span>

            <!-- Tabs de filtro -->
            <div class="factchecking-tabs">
                <button class="factchecking-tab active" data-filter="partido" onclick="switchFactcheckingTab('partido')">
                    Partido
                </button>
                <button class="factchecking-tab" data-filter="candidato" onclick="switchFactcheckingTab('candidato')">
                   Candidato
                </button>
                <button class="factchecking-tab" data-filter="veredicto" onclick="switchFactcheckingTab('veredicto')">
                    Veredicto
                </button>
            </div>

            <!-- Buscador de texto (para partido y candidato) -->
            <div class="factchecking-search-container" id="factcheckingSearchContainer">
                <div class="factchecking-search-box">
                    <input type="text" 
                        id="factcheckingSearchInput" 
                        placeholder="Buscar partido..." 
                        autocomplete="off"
                        onkeyup="handleFactcheckingSearch(event)"
                        onfocus="showFactcheckingAutocomplete()">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <div class="factchecking-autocomplete" id="factcheckingAutocomplete">
                        <!-- Autocomplete items se generar√°n aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- Dropdown para veredicto (oculto por defecto) -->
            <div class="factchecking-dropdown-container" id="factcheckingDropdownContainer" style="display: none;">
                <select class="factchecking-dropdown" id="factcheckingVeredictoDropdown" onchange="handleVeredictoChange()">
                    <option value="">Seleccionar veredicto...</option>
                    <option value="verdadera">Verdadero</option>
                    <option value="falsa">Falso</option>
                    <option value="enganosa">Enga√±oso</option>
                </select>
            </div>

            <!-- Loading -->
            <div class="factchecking-loading" id="factcheckingLoading">
                <div class="factchecking-spinner"></div>
                <p>Cargando datos...</p>
            </div>

            <!-- Grid de cards -->
            <div class="factchecking-grid" id="factcheckingGrid" style="display: none;">
                <!-- Las cards se generar√°n din√°micamente -->
            </div>   

            <!-- Bot√≥n Ver M√°s -->
            <div class="factchecking-load-more" id="factcheckingLoadMore" style="display: none;">
                <button class="load-more-btn" onclick="loadMoreFactchecking()">
                    Ver m√°s
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">                    
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </button>
                <span class="load-more-count" id="loadMoreCount"></span>
            </div>

            <!-- No results -->
            <div class="factchecking-no-results" id="factcheckingNoResults" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <p>No se encontraron resultados</p>
            </div>

            <!-- Estado inicial: invitar a buscar -->
            <div class="factchecking-initial" id="factcheckingInitial">
            </div>
        </section>

        <div class="box-titulo-seccion">
            <span class="linea-titulo-seccion"></span>
            <h3>¬øSab√≠as que?</h3>
            <p>Descubre en segundos los datos que mejor explican las propuestas</p>            
            
            <img src="./img/icon-horizontal-scroll.png" alt="" width="100%">
            <span>Has scroll horizontal</span>
        
        </div>

        
        <div class="main-tarjetas">
            <div class="scroll-container">
        
                <div class="card theme-pink">
                    <div class="icon-box">
                        <img src="./img/icon-card-1.jpg" alt="" width="100%">
                    </div>
                    <h3>Cobertura por plan</h3>
                    <div class="color-line"></div>
                    <p>Mientras el plan m√°s completo abarca <span>17 ejes y el m√°s escueto se limita a solo 3.</span> El promedio general se sit√∫a en 14 temas por partido.</p>
                    <div class="separator-dotted"></div>
                    <p>Muchos temas indican amplitud, no necesariamente mejor sustento.</p>
                </div>

                <div class="card theme-blue">
                    <div class="icon-box">
                        <img src="./img/icon-card-2.jpg" alt="" width="100%">
                    </div>
                    <h3>Agenda compartida</h3>
                    <div class="color-line"></div>
                    <p>Cuatro temas figuran en la agenda de casi todos los partidos: <span>Econom√≠a, Educaci√≥n, Infraestructura y Salud. Son el eje base de sus propuestas.</span></p>
                    <div class="separator-dotted"></div>
                    <p>Alta presencia = tema transversal en la agenda.</p>
                </div>

                <div class="card theme-yellow">
                    <div class="icon-box">
                        <img src="./img/icon-card-3.jpg" alt="" width="100%">
                    </div>
                    <h3>Los temas menos presentes</h3>
                    <div class="color-line"></div>
                    <p>Temas como <span> Familia, Cultura y Transporte</span> aparecen de forma escueta o son ignorados por las agrupaciones.</p>
                    <div class="separator-dotted"></div>
                    <p>Baja presencia ‚â† irrelevancia</p>
                </div>

                <div class="card theme-orange">
                    <div class="icon-box">
                        <img src="./img/icon-card-4.jpg" alt="" width="100%">
                    </div>
                    <h3>M√°s espacio en los planes</h3>
                    <div class="color-line"></div>
                    <p style="margin-top: auto; margin-bottom: auto;"><span>La Econom√≠a (14.2%) y los Programas Sociales (13.8%)</span> dominan la narrativa, consumiendo casi un tercio del texto total de los planes. Les siguen Salud y Justicia.</p>
                    <div class="separator-dotted"></div>
                    <p>M√°s porcentaje = m√°s espacio, no mejor propuesta.</p>
                </div>

                <div class="card theme-cyan">
                    <div class="icon-box">
                        <img src="./img/icon-card-5.jpg" alt="" width="100%">
                    </div>
                    <h3>Menos espacio en los planes</h3>
                    <div class="color-line"></div>
                    <p style="margin-top: auto; margin-bottom: auto;">Pese a su importancia ciudadana, temas como  <span>Transporte (1.2%) y Cultura (1.4%)</span> ocupan un espacio insignificante en la redacci√≥n de los documentos.</p>
                    <div class="separator-dotted"></div>
                    <p>Poco espacio no representa calidad.</p>
                </div>

                <div class="card theme-teal">
                    <div class="icon-box">
                        <img src="./img/icon-card-6.jpg" alt="" width="100%">
                    </div>
                    <h3>Tema dominante por plan</h3>
                    <div class="color-line"></div>
                    <p style="margin-top: auto; margin-bottom: auto;">La Econom√≠a no solo es transversal, <span>sino que es el tema que acapara el mayor volumen de palabras (14.2%) </span>en el promedio nacional.</p>
                    <div class="separator-dotted"></div>
                    <p>Muestra prioridad, mas no la profundidad.</p>
                </div>
            </div>
        </div>  

        <div class="box-titulo-seccion">
            <span class="linea-titulo-seccion"></span>
            <h3>Panorama general</h3>
        </div>

        <!-- panorama general -->
        <div class="box-main-panorama">
            <h2>Diversidad tem√°tica</h2>
            <p>
                Aqu√≠ ver√°s la variedad de √°reas tratadas en el plan. Un plan con muchos temas ofrece una mayor cobertura, aunque no siempre puede entrar en detalle ni mostrar sustento en cada √°rea.
            </p>

            <div class="box-flourish">
                <div class="flourish-embed flourish-chart" data-src="visualisation/25750063"><script src="https://public.flourish.studio/resources/embed.js"></script><noscript><img src="https://public.flourish.studio/visualisation/25750063/thumbnail" width="100%" alt="chart visualization" /></noscript></div>
            </div>

            <h2>Densidad discursiva</h2>
            <p>
                Descubre el porcentaje del plan que ocupa cada tema. M√°s espacio no implica mayor concreci√≥n ni mejor sustento.
            </p>

            <!-- Secci√≥n de Densidad Discursiva -->
            <div class="density-section" id="densitySection">

                <div class="density-controls">
                    <div class="party-selector">
                        <select id="densityPartyFilter" onchange="updateDensityFilter()">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <div class="theme-slider-container">
                        <div class="theme-slider" id="themeSlider">
                            <div class="theme-segments" id="themeSegments">
                                <!-- Segmentos se generar√°n din√°micamente -->
                            </div>
                            <div class="slider-handle" id="sliderHandle"></div>
                        </div>
                        <div class="theme-labels" id="themeLabels">
                            <!-- Labels se generar√°n din√°micamente -->
                        </div>
                    </div>
                </div>

                <div class="party-list" id="partyDensityList">
                    <!-- Lista de partidos con barras se generar√° aqu√≠ -->
                </div>
            </div>


            <h2>Prevalencia tem√°tica</h2>
            <p>
                Mide en cu√°ntos partidos aparece cada tema. Un valor m√°s alto indica un tema m√°s transversal en la agenda. No eval√∫a detalle, coherencia ni evidencia.
            </p>

            <div class="box-flourish">
                <div class="flourish-embed flourish-hierarchy" data-src="visualisation/25769480"><script src="https://public.flourish.studio/resources/embed.js"></script><noscript><img src="https://public.flourish.studio/visualisation/25769480/thumbnail" width="100%" alt="hierarchy visualization" /></noscript></div>
            </div>

        </div>

        <div class="box-metodologia">
            <h6>metodolog√≠a</h6>
            <p>
                Este especial se basa en informaci√≥n p√∫blica de los planes de gobierno que cada partido suministra al JNE. Los documentos se procesaron con el programa de automatizaci√≥n n8n para su lectura, limpieza, estandarizaci√≥n y unificaci√≥n. El contenido se clasific√≥ por temas con asistencia de IA y se calcularon indicadores como diversidad tem√°tica, densidad discursiva y prevalencia. Para los res√∫menes finales se emplearon modelos de OpenAI y Gemini, con edici√≥n y validaci√≥n editorial antes de la publicaci√≥n. El resultado es una s√≠ntesis comparable y clara, pensada para consulta r√°pida sin perder rigor.
            </p>
            <p>
                Para caracterizar el tono y la coherencia se aplic√≥ un enfoque de an√°lisis del discurso pol√≠tico (referencias: van Dijk, Fairclough, Habermas) y coherencia program√°tica (Klingemann et al.). El tono se etiqueta por fragmento como: T√©cnico (gesti√≥n p√∫blica, evidencia, indicadores), Ideol√≥gico (valores, principios, identidad), Pragm√°tico (acciones viables, implementaci√≥n) o Social (inclusi√≥n, bienestar, equidad). La coherencia interna se valora en Alta / Media / Baja seg√∫n el alineamiento entre diagn√≥stico y medidas, la ausencia de contradicciones y la claridad de metas.
            </p>
        </div>

    </div>

    <div class="box-footer">
        <img src="./img/logo-comercio.png" alt="El Comercio" width="100%" class="logo-comercio">
        <ul>
            <li>
                <p>
                    <span>Investigaci√≥n y textos:</span>
                </p>
            </li>
            <li>
                <p>
                    Gisella Salm√≥n
                </p>
            </li>
            <li>
                <p>
                    Mayt√© Ciriaco
                </p>
            </li>
            <li>
                <p>
                    Lorena Obreg√≥n
                </p>
            </li>

            <li>
                <p>
                    <span>Dise√±o:</span>
                </p>
            </li>
            <li>
                <p>
                    Marcelo Hidalgo
                </p>
            </li>

            <li>
                <p>
                    <span>Ilustraciones y animaci√≥n:</span>
                </p>
            </li>
            <li>
                <p>
                    Kiomy Kanashiro
                </p>
            </li>
        </ul>

        <ul>
            <li>
                <p>
                    <span>Programaci√≥n:</span>
                </p>
            </li>
            <li>
                <p>
                    Armando Scargglioni C.
                </p>
            </li>
            <li>
                <p>
                    Edici√≥n visual:
                </p>
            </li>
            <li>
                <p>
                    Angela Pe√±a
                </p>
            </li>

            <li>
                <p>
                    <span>Producci√≥n general:</span>
                </p>
            </li>
            <li>
                <p>
                    Gisella Salm√≥n
                </p>
            </li>

            <li>
                <p>
                    <span>Director period√≠stico:</span>
                </p>
            </li>
            <li>
                <p>
                    Juan Aurelio Ar√©valo
                </p>
            </li>
        </ul>
    </div>

    <!-- compartir -->
    <script>
        function shareUrl(event) {
            const button = event.target;
            const url = button.getAttribute('data-url');
            
            const sharer = button.getAttribute('data-sharer');
            let shareUrl = '';

            switch (sharer) {
            case 'facebook':
                const fbHashtag = button.getAttribute('data-hashtag') || '';
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&hashtag=${encodeURIComponent(fbHashtag)}`;
                break;
                
            case 'whatsapp':
                const whatsappTitle = button.getAttribute('data-title');
                shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(whatsappTitle + ' ' + url)}`;
                break;
                
            case 'twitter':
                const twitterTitle = button.getAttribute('data-title');
                const twitterHashtags = button.getAttribute('data-hashtags');
                const twitterVia = button.getAttribute('data-via');
                shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(twitterTitle)}&url=${encodeURIComponent(url)}&hashtags=${twitterHashtags}&via=${twitterVia}`;
                break;
            }

            window.open(shareUrl, '_blank');
        }

        document.querySelectorAll('.sharer').forEach(button => {
            button.addEventListener('click', shareUrl);
        });
    </script>   

    <!-- cards resumen -->
    <script>
        const slider = document.querySelector('.scroll-container');
        let isDown = false;
        let startX;
        let scrollLeft;

        slider.addEventListener('mousedown', (e) => {
            isDown = true;
            slider.classList.add('active'); // Cambia el cursor a 'grabbing'
            startX = e.pageX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
        });

        slider.addEventListener('mouseleave', () => {
            isDown = false;
            slider.classList.remove('active');
        });

        slider.addEventListener('mouseup', () => {
            isDown = false;
            slider.classList.remove('active');
        });

        slider.addEventListener('mousemove', (e) => {
            if (!isDown) return; // Si no est√° clickeado, no hace nada
            e.preventDefault(); // Evita selecciones de texto raras
            const x = e.pageX - slider.offsetLeft;
            const walk = (x - startX) * 2; // El * 2 es la velocidad del scroll
            slider.scrollLeft = scrollLeft - walk;
        });
      
    </script>

    <!-- anclas botones -->
    <script>
        // Smooth scroll para las anclas
            document.addEventListener('DOMContentLoaded', function() {
                // Obtener todos los elementos li del men√∫ de anclas
                const anchorItems = document.querySelectorAll('ul.anclas li');
                
                // Mapeo de los li con sus correspondientes divs
                const sections = [
                    { element: anchorItems[0], target: '#box-main-candidatos' },
                    { element: anchorItems[1], target: '#comparisonSection' },
                    { element: anchorItems[2], target: '.box-main-panorama' }
                ];
                
                // Agregar event listeners a cada li
                sections.forEach(function(section) {
                    if (section.element) {
                        section.element.addEventListener('click', function() {
                            const targetElement = document.querySelector(section.target);
                            
                            if (targetElement) {
                                // Scroll suave hacia el elemento
                                targetElement.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'start'
                                });
                                
                                // Opcional: agregar clase active al li clickeado
                                anchorItems.forEach(item => item.classList.remove('active'));
                                section.element.classList.add('active');
                            }
                        });
                    }
                });
            });
    </script>

    <!-- buscador y comparador de candidatos o partidos -->
    <script>
        // ============================================
        // CONFIGURACI√ìN: URLs de Google Spreadsheets
        // ============================================
        
        // Hoja 1: Datos generales de partidos y candidatos
        const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR_yZQbmqUse6lOcFRxBhP53YkC3CdIc36YcOE3bk-w_91-TVudDvH9uVuJoSMZwf_4bPPuq--qbHKb/pub?output=csv';
        
        // Hoja 2: Datos de comparaci√≥n por temas
        const COMPARISON_SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRcgvr6YP_YLsgXS9-mJD34bBug-Qzlv8W_d3ZacfQhYcM-7u85u-U6TCl8S9rsBDVPD8Ck5mMsYNxW/pub?output=csv';
        
        // ============================================
        // Funciones de Cache-Busting
        // ============================================
        
        // Agregar timestamp para evitar cach√©
        function addCacheBuster(url) {
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}_=${new Date().getTime()}`;
        }        
        
        // ============================================
        // Variables globales - Secci√≥n Buscador
        // ============================================
        let currentTab = 'partido';
        let allData = [];
        let filteredData = [];
        
        // ============================================
        // Variables globales - Secci√≥n Densidad Discursiva
        // ============================================
        
        // URL del archivo JSON con datos de densidad
        const DENSITY_DATA_URL = './data/densidad-data.json';
        
        const themes = [
            { id: 'agricultura', name: 'AGRICULTURA', color: '#3B82F6' },
            { id: 'medio-ambiente', name: 'AMBIENTE', color: '#EF4444' },
            { id: 'cambio-climatico', name: 'CAMBIO CLIM√ÅTICO', color: '#10B981' },
            { id: 'cultura-turismo', name: 'CULTURA Y TURISMO', color: '#F59E0B' },
            { id: 'descentralizacion', name: 'DESCENTRALIZACI√ìN', color: '#8B5CF6' },
            { id: 'economia', name: 'ECONOM√çA', color: '#06B6D4' },
            { id: 'educacion', name: 'EDUCACI√ìN', color: '#06B6D4' },
            { id: 'energia-minera', name: 'ENERG√çA MINERA', color: '#06B6D4' },
            { id: 'familia', name: 'FAMILIA', color: '#06B6D4' },
            { id: 'gobernanza-digital', name: 'GOBERNANZA DIGITAL', color: '#06B6D4' },
            { id: 'infraestructura', name: 'INFRAESTRUCTURA', color: '#06B6D4' },
            { id: 'justicia-dh', name: 'JUSTICIA', color: '#06B6D4' },
            { id: 'programas-sociales', name: 'PROGRAMAS SOCIALES', color: '#06B6D4' },
            { id: 'salud', name: 'SALUD', color: '#06B6D4' },
            { id: 'seguridad', name: 'SEGURIDAD', color: '#06B6D4' },
            { id: 'transporte', name: 'TRANSPORTE', color: '#06B6D4' },
            { id: 'vivienda', name: 'VIVIENDA', color: '#06B6D4' }
        ];
        
        let selectedThemeIndex = 1; // Por defecto: SALUD
        let densityFilteredParty = '';
        let densityData = {};

        // ============================================
        // Funciones de Densidad Discursiva
        // ============================================

        // Cargar datos de densidad desde JSON
        async function loadDensityData() {
            try {
                const response = await fetch(DENSITY_DATA_URL);
                if (!response.ok) {
                    throw new Error('Error al cargar datos de densidad');
                }
                const data = await response.json();
                
                // Convertir array a objeto indexado por ID
                densityData = {};
                data.partidos.forEach(partido => {
                    densityData[partido.id] = {
                        partido: partido.nombre,
                        logoUrl: partido.logoUrl || '',
                        temas: partido.densidad
                    };
                });
                
                console.log('üìä Datos de densidad cargados:', densityData);
                return densityData;
            } catch (error) {
                console.error('‚ùå Error cargando datos de densidad:', error);
                console.log('‚ö†Ô∏è Usando datos de ejemplo...');
                
                // Datos de ejemplo si falla la carga
                densityData = {
                    "1": {
                        partido: "Partido 1",
                        logoUrl: "",
                        temas: {
                            educacion: 15,
                            salud: 25,
                            economia: 20,
                            seguridad: 18,
                            infraestructura: 12,
                            "medio-ambiente": 10
                        }
                    },
                    "2": {
                        partido: "Partido 2",
                        logoUrl: "",
                        temas: {
                            educacion: 22,
                            salud: 28,
                            economia: 15,
                            seguridad: 10,
                            infraestructura: 15,
                            "medio-ambiente": 10
                        }
                    }
                };
                return densityData;
            }
        }

        // Inicializar slider de temas
        function initThemeSlider() {
            const segmentsContainer = document.getElementById('themeSegments');
            const labelsContainer = document.getElementById('themeLabels');
            const slider = document.getElementById('themeSlider');
            
            // Crear segmentos SIN labels dentro
            segmentsContainer.innerHTML = themes.map((theme, index) => `
                <div class="theme-segment theme-${theme.id} ${index === selectedThemeIndex ? 'active' : ''}" 
                     data-index="${index}"
                     onclick="selectTheme(${index})">
                </div>
            `).join('');
            
            // Crear labels fuera de los segmentos
            labelsContainer.innerHTML = themes.map((theme, index) => `
                <div class="theme-label-item ${index === selectedThemeIndex ? 'active' : ''}" 
                     data-index="${index}">
                    ${theme.name}
                </div>
            `).join('');

            // Posicionar labels din√°micamente basado en el n√∫mero de temas
            const totalThemes = themes.length;
            const labelItems = labelsContainer.querySelectorAll('.theme-label-item');
            labelItems.forEach((label, index) => {
                // Calcular la posici√≥n central de cada segmento
                const centerPosition = (100 / totalThemes) * (index + 0.1);
                label.style.left = `${centerPosition}%`;
            });
            
            // Posicionar handle en el centro del segmento
            updateSliderHandle();
            
            // Hacer el slider clickeable
            slider.addEventListener('click', (e) => {
                if (e.target.classList.contains('theme-segment') || e.target.closest('.theme-segment')) {
                    return; // Ya manejado por onclick del segmento
                }
                handleSliderDrag(e.clientX);
            });
        }

        // Manejar arrastre del slider
        function handleSliderDrag(clientX) {
            const slider = document.getElementById('themeSlider');
            const rect = slider.getBoundingClientRect();
            const x = clientX - rect.left;
            const percentage = Math.max(0, Math.min(1, x / rect.width));
            const newIndex = Math.round(percentage * (themes.length - 1));
            
            if (newIndex !== selectedThemeIndex) {
                selectTheme(newIndex);
            }
        }

        // Seleccionar tema
        function selectTheme(index) {
            selectedThemeIndex = index;
            
            // Actualizar segmentos activos y dimmed
            document.querySelectorAll('.theme-segment').forEach((seg, i) => {
                seg.classList.toggle('active', i === index);
                seg.classList.toggle('dimmed', i !== index);
            });
            
            // Actualizar labels activos
            document.querySelectorAll('.theme-label-item').forEach((label, i) => {
                label.classList.toggle('active', i === index);
            });
            
            // Actualizar handle
            updateSliderHandle();
            
            // Actualizar visualizaci√≥n
            renderDensityBars();
        }

        // Actualizar posici√≥n del handle
        function updateSliderHandle() {
            const slider = document.getElementById('themeSlider');
            const handle = document.getElementById('sliderHandle');
            const segments = document.querySelectorAll('.theme-segment');
            
            if (segments.length === 0) return;
            
            // Obtener el segmento activo
            const activeSegment = segments[selectedThemeIndex];
            const segmentRect = activeSegment.getBoundingClientRect();
            const sliderRect = slider.getBoundingClientRect();
            
            // Posicionar el handle en el centro del segmento
            const segmentCenter = segmentRect.left - sliderRect.left + (segmentRect.width / 2);
            handle.style.left = `${segmentCenter}px`;
        }

        // Renderizar barras de densidad
        function renderDensityBars() {
            const container = document.getElementById('partyDensityList');
            const selectedTheme = themes[selectedThemeIndex].id;
            const isMobile = window.innerWidth <= 768;
            
            // Filtrar partidos si hay selecci√≥n
            let partidosToShow = Object.keys(densityData);
            if (densityFilteredParty) {
                partidosToShow = partidosToShow.filter(id => id == densityFilteredParty);
            }
            
            if (isMobile) {
                // Layout m√≥vil: cada partido con su nombre y barra juntos
                container.className = 'party-list mobile-view';
                container.innerHTML = partidosToShow.map(partidoId => {
                    const partido = densityData[partidoId];
                    const highlightClass = densityFilteredParty == partidoId ? 'highlighted' : '';
                    
                    const logoHTML = partido.logoUrl 
                        ? `<img src="${partido.logoUrl}" alt="${partido.partido}" onerror="this.style.display='none';">` 
                        : 'üçé';
                    
                    const segmentsHTML = themes.map((theme, themeIndex) => {
                        const percentage = partido.temas[theme.id] || 0;
                        const isSelected = theme.id === selectedTheme;
                        const dimmedClass = selectedTheme ? (isSelected ? 'highlighted' : 'dimmed') : '';
                        
                        return `
                            <div class="density-segment theme-${theme.id} ${dimmedClass}" 
                                 style="width: ${percentage}%"
                                 data-theme="${theme.id}"
                                 data-theme-index="${themeIndex}"
                                 onclick="selectThemeFromBar(${themeIndex})">
                                <div class="density-tooltip">${theme.name}: ${percentage}%</div>
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div class="party-complete-item ${highlightClass}">
                            <div class="party-complete-header">
                                <div class="party-density-icon">${logoHTML}</div>
                                <div class="party-density-name">${partido.partido}</div>
                            </div>
                            <div class="party-complete-bar">
                                <div class="party-density-bar-container">
                                    <div class="party-density-bar">
                                        ${segmentsHTML}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Layout desktop: dos columnas
                container.className = 'party-list';
                
                // Crear columna de nombres
                const namesHTML = partidosToShow.map(partidoId => {
                    const partido = densityData[partidoId];
                    const logoHTML = partido.logoUrl 
                        ? `<img src="${partido.logoUrl}" alt="${partido.partido}" onerror="this.style.display='none';">` 
                        : 'üçé';
                    const highlightClass = densityFilteredParty == partidoId ? 'highlighted' : '';
                    
                    return `
                        <div class="party-name-item ${highlightClass}">
                            <div class="party-density-item">
                                <div class="party-density-icon">${logoHTML}</div>
                                <div class="party-density-name">${partido.partido}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Crear columna de barras
                const barsHTML = partidosToShow.map(partidoId => {
                    const partido = densityData[partidoId];
                    const highlightClass = densityFilteredParty == partidoId ? 'highlighted' : '';
                    
                    const segmentsHTML = themes.map((theme, themeIndex) => {
                        const percentage = partido.temas[theme.id] || 0;
                        const isSelected = theme.id === selectedTheme;
                        const dimmedClass = selectedTheme ? (isSelected ? 'highlighted' : 'dimmed') : '';
                        
                        return `
                            <div class="density-segment theme-${theme.id} ${dimmedClass}" 
                                 style="width: ${percentage}%"
                                 data-theme="${theme.id}"
                                 data-theme-index="${themeIndex}"
                                 onclick="selectThemeFromBar(${themeIndex})">
                                <div class="density-tooltip">${theme.name}: ${percentage}%</div>
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div class="party-bar-item ${highlightClass}">
                            <div class="party-density-bar-container">
                                <div class="party-density-bar">
                                    ${segmentsHTML}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div class="party-names-column">
                        ${namesHTML}
                    </div>
                    <div class="party-bars-column">
                        ${barsHTML}
                    </div>
                `;
            }
        }

        // Seleccionar tema desde la barra de un partido
        function selectThemeFromBar(themeIndex) {
            selectTheme(themeIndex);
            
            // Scroll suave al slider
            const slider = document.getElementById('themeSlider');
            slider.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Actualizar filtro de partido
        function updateDensityFilter() {
            densityFilteredParty = document.getElementById('densityPartyFilter').value;
            renderDensityBars();
        }

        // Poblar selector de partidos
        function populateDensityPartySelector() {
            const select = document.getElementById('densityPartyFilter');
            
            const options = Object.keys(densityData).map(partidoId => {
                const partido = densityData[partidoId];
                return `<option value="${partidoId}">${partido.partido}</option>`;
            }).join('');
            
            select.innerHTML = '<option value="">Todos los partidos</option>' + options;
        }

        // ============================================
        // Variables globales - Secci√≥n Comparador
        // ============================================
        let comparisonDataList = [];
        let selectedComparisons = [null, null, null]; // M√°ximo 3 comparaciones
        let currentComparisonTheme = '';

        // ============================================
        // Funciones del Comparador
        // ============================================

        // Cargar datos de comparaci√≥n desde Google Sheets
        async function loadComparisonData() {
            try {
                const response = await fetch(addCacheBuster(COMPARISON_SPREADSHEET_URL));
                if (!response.ok) {
                    throw new Error('Error al cargar datos de comparaci√≥n');
                }
                const csvText = await response.text();
                comparisonDataList = parseCSV(csvText);
                console.log('‚úÖ Datos de comparaci√≥n cargados:', comparisonDataList);
                console.log('üìä Total de registros:', comparisonDataList.length);
                console.log('üîë Columnas disponibles:', Object.keys(comparisonDataList[0] || {}));
                return comparisonDataList;
            } catch (error) {
                console.error('‚ùå Error cargando datos de comparaci√≥n:', error);
                alert('Error al cargar los datos de comparaci√≥n. Verifica que la URL del Google Sheet sea correcta y que est√© publicado como CSV.');
                return [];
            }
        }

        // Actualizar tema de comparaci√≥n
        function updateComparisonTheme() {
            currentComparisonTheme = document.getElementById('themeSelector').value;
            renderComparisonCards();
        }

        // Renderizar tarjetas de comparaci√≥n
        function renderComparisonCards() {
            const grid = document.getElementById('comparisonGrid');
            
            // S√≥lo usar elementos de tipo 'partido' para las opciones del comparador
            const partyOptions = allData.filter(d => d.tipo === 'partido');
            
            grid.innerHTML = selectedComparisons.map((item, index) => {
                if (!item) {
                    return `
                        <div class="comparison-card empty">
                            <div style="font-size: 48px; color: #ddd;">+</div>
                            <p>Selecciona un partido</p>
                            <div class="card-selector" style="width: 100%; max-width: 250px;">
                                <select onchange="addToComparison(${index}, this.value)">
                                    <option value="">Partido</option>
                                    ${partyOptions.map(d => `<option value="${d.id}">${d.nombre}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    `;
                }
                
                return renderComparisonCard(item, index);
            }).join('');
        }

        // Renderizar una tarjeta de comparaci√≥n con datos
        function renderComparisonCard(item, index) {
            console.log('üîç Renderizando tarjeta:', {
                index: index,
                itemId: item.id,
                itemNombre: item.nombre,
                tema: currentComparisonTheme
            });

            const compData = comparisonDataList.find(c => {
                const match = c.partidoId == item.id && c.tema === currentComparisonTheme;
                if (currentComparisonTheme) {
                    console.log('üîé Comparando:', {
                        'c.partidoId': c.partidoId,
                        'item.id': item.id,
                        'coincide ID': c.partidoId == item.id,
                        'c.tema': c.tema,
                        'currentTheme': currentComparisonTheme,
                        'coincide tema': c.tema === currentComparisonTheme,
                        'match final': match
                    });
                }
                return match;
            });
            
            console.log('Buscando datos para:', {
                partidoId: item.id,
                tema: currentComparisonTheme,
                encontrado: !!compData,
                datosDisponibles: comparisonDataList.length,
                partidosEnData: [...new Set(comparisonDataList.map(c => c.partidoId))],
                temasEnData: [...new Set(comparisonDataList.map(c => c.tema))]
            });
            
            if (!compData && currentComparisonTheme) {
                return `
                    <div class="comparison-card">
                        <button class="remove-card" onclick="removeFromComparison(${index})">√ó</button>
                        <div class="card-profile">
                            <div class="card-avatar">
                                ${item.fotoUrl ? `<img src="${item.fotoUrl}" alt="${item.candidato}">` : '<div class="card-avatar-icon"></div><div class="card-avatar-body"></div>'}
                            </div>
                            <div class="card-name">${item.candidato}</div>
                            <div class="card-party">${item.nombre}</div>
                        </div>
                        <p style="text-align: center; color: #999; padding: 40px 20px;">
                            No hay informaci√≥n disponible para este tema
                        </p>
                    </div>
                `;
            }
            
            const avatarHTML = item.fotoUrl 
                ? `<img src="${item.fotoUrl}" alt="${item.candidato}" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'card-avatar-icon\\'></div><div class=\\'card-avatar-body\\'></div>';">` 
                : '<div class="card-avatar-icon"></div><div class="card-avatar-body"></div>';
            
            if (!currentComparisonTheme) {
                // S√≥lo mostrar partidos en el select de cambio
                const partyOptions = allData.filter(d => d.tipo === 'partido' && d.id != item.id);
                
                return `
                    <div class="comparison-card">
                        <button class="remove-card" onclick="removeFromComparison(${index})">√ó</button>
                        <div class="card-selector">
                            <select onchange="changeComparison(${index}, this.value)">
                                <option value="${item.id}" selected>${item.nombre}</option>
                                ${allData.filter(d => d.id != item.id && d.tipo === 'partido').map(d => 
                                    `<option value="${d.id}">${d.nombre}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="card-profile">
                            <div class="card-avatar">${avatarHTML}</div>
                            <div class="card-name">${item.candidato || item.nombre}</div>
                            <div class="card-party">${item.nombre}</div>
                        </div>
                        <p style="text-align: center; color: #999; padding: 40px 20px;">
                            Selecciona un tema arriba para ver las propuestas
                        </p>
                    </div>
                `;
            }
            
            // Renderizar con datos completos
            const propuestasHTML = compData.propuestas ? 
                `<ul>${compData.propuestas.split('\n').filter(p => p.trim()).map(p => `<li>${p.replace(/^- /, '')}</li>`).join('')}</ul>` 
                : '<p>No hay propuestas disponibles</p>';
            
            return `
                <div class="comparison-card">
                    <button class="remove-card" onclick="removeFromComparison(${index})">√ó</button>
                    <div class="card-selector">
                        <select onchange="changeComparison(${index}, this.value)">
                            <option value="${item.id}" selected>${item.nombre}</option>
                            ${allData.filter(d => d.id != item.id && d.tipo === 'partido').map(d => 
                                `<option value="${d.id}">${d.nombre}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="card-profile">
                        <div class="card-avatar">${avatarHTML}</div>
                        <div class="card-name">${item.candidato || item.nombre}</div>
                        <div class="card-party">${item.nombre}</div>
                    </div>
                    <div class="card-content">
                        ${compData.tituloPropuesta ? `
                            <div class="proposal-title-label">titulo-propuesta</div>
                            <div class="proposal-title">${compData.tituloPropuesta}</div>
                        ` : ''}
                        <div class="content-section">
                            ${propuestasHTML}
                        </div>
                        ${compData.tonoDiscursivo || compData.coherencia ? `
                            <div class="discourse-tone">
                                <p><strong>TONO DISCURSIVO:</strong> ${compData.tonoDiscursivo || 'N/A'}</p>
                                <p><strong>COHERENCIA:</strong> ${compData.coherencia || 'N/A'}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Agregar partido/candidato a la comparaci√≥n
        function addToComparison(index, itemId) {
            if (!itemId) return;
            
            // S√≥lo permitir partidos
            const item = allData.find(d => d.id == itemId && d.tipo === 'partido');
            if (item) {
                selectedComparisons[index] = item;
                renderComparisonCards();
            } else {
                alert('Solo se pueden seleccionar partidos para la comparaci√≥n.');
            }
        }

        // Cambiar partido/candidato en la comparaci√≥n
        function changeComparison(index, itemId) {
            if (!itemId) return;
            
            // S√≥lo permitir partidos
            const item = allData.find(d => d.id == itemId && d.tipo === 'partido');
            if (item) {
                selectedComparisons[index] = item;
                renderComparisonCards();
            } else {
                alert('Solo se pueden seleccionar partidos para la comparaci√≥n.');
            }
        }

        // Remover de la comparaci√≥n
        function removeFromComparison(index) {
            selectedComparisons[index] = null;
            renderComparisonCards();
        }

        // Funci√≥n mejorada de scroll a la secci√≥n de comparar
        function scrollToCompare() {
            const comparisonSection = document.getElementById('comparisonSection');
            comparisonSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Agregar al comparador desde el bot√≥n "Comparar" del detalle
        function addToCompare(item) {
            // Si nos pasaron un string id, intentar resolver
            if (typeof item === 'string' || typeof item === 'number') {
                const resolved = allData.find(d => d.id == item && d.tipo === 'partido');
                if (!resolved) {
                    alert('Solo puedes comparar partidos. Selecciona un partido desde la pesta√±a "Partidos".');
                    return;
                }
                item = resolved;
            }
            
            // Si el objeto no es tipo partido, intentar mapear al partido correspondiente
            if (item.tipo !== 'partido') {
                // Buscar partido por nombre de partido en el registro del candidato
                const partyName = item.nombrePartido || item.partido || item.nombre;
                const partido = allData.find(d => d.tipo === 'partido' && d.nombre === partyName);
                
                if (partido) {
                    item = partido;
                } else {
                    alert('No es posible a√±adir candidatos al comparador. S√≥lo se permiten partidos.');
                    return;
                }
            }
            
            // Buscar el primer espacio vac√≠o
            const emptyIndex = selectedComparisons.findIndex(c => c === null);
            
            if (emptyIndex !== -1) {
                selectedComparisons[emptyIndex] = item;
                renderComparisonCards();
                scrollToCompare();
            } else {
                // Si ya hay 3 partidos, reemplazar el √∫ltimo
                selectedComparisons[2] = item;
                renderComparisonCards();
                scrollToCompare();
            }
        }

        // ============================================
        // Funciones del Buscador Principal
        // ============================================

        // Funci√≥n para refrescar todos los datos (sin UI, para uso program√°tico)
        async function refreshAllData() {
            try {
                console.log('üîÑ Refrescando todos los datos...');
                
                // Recargar datos del buscador
                await loadDataFromGoogleSheets();
                
                // Recargar datos del comparador
                await loadComparisonData();
                
                // IMPORTANTE: Forzar re-render del comparador despu√©s de cargar
                console.log('üîÑ Actualizando tarjetas del comparador...');
                renderComparisonCards();
                
                // Recargar datos de densidad
                await loadDensityData().then(() => {
                    populateDensityPartySelector();
                    renderDensityBars();
                });
                
                console.log('‚úÖ Todos los datos actualizados correctamente');
                console.log('üìä Comparaciones:', selectedComparisons);
                console.log('üìä Datos de comparaci√≥n:', comparisonDataList.length, 'registros');
                
            } catch (error) {
                console.error('‚ùå Error al refrescar datos:', error);
            }
        }

        // Inicializar la aplicaci√≥n
        function init() {
            loadDataFromGoogleSheets();
            loadComparisonData();
            renderComparisonCards();
            
            // Cargar y renderizar densidad discursiva
            loadDensityData().then(() => {
                initThemeSlider();
                populateDensityPartySelector();
                renderDensityBars();
                
                // Reposicionar handle en resize
                window.addEventListener('resize', () => {
                    updateSliderHandle();
                });
            });
            
            // Atajo de teclado opcional: Ctrl+Shift+R para refrescar todos los datos
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                    e.preventDefault();
                    console.log('‚å®Ô∏è Atajo de teclado: Refrescando datos...');
                    refreshAllData();
                }
            });
        }

        // Funci√≥n para parsear CSV
        function parseCSV(csv) {
            // Dividir por saltos de l√≠nea pero respetando comillas
            const lines = [];
            let currentLine = '';
            let inQuotes = false;
            
            for (let i = 0; i < csv.length; i++) {
                const char = csv[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                    currentLine += char;
                } else if (char === '\n' && !inQuotes) {
                    if (currentLine.trim()) {
                        lines.push(currentLine);
                    }
                    currentLine = '';
                } else {
                    currentLine += char;
                }
            }
            
            // Agregar la √∫ltima l√≠nea si existe
            if (currentLine.trim()) {
                lines.push(currentLine);
            }
            
            console.log('üîç Parseando CSV...');
            console.log('üìè Total de l√≠neas encontradas:', lines.length);
            
            if (lines.length === 0) {
                console.error('‚ùå No se encontraron l√≠neas en el CSV');
                return [];
            }
            
            const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/^"|"$/g, ''));
            console.log('üìã Headers encontrados:', headers);
            
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = parseCSVLine(lines[i]);
                const row = {};
                
                headers.forEach((header, index) => {
                    let value = values[index] || '';
                    // Limpiar comillas al inicio y final
                    value = value.trim().replace(/^"|"$/g, '');
                    row[header] = value;
                });
                
                // Procesar temas y descripciones (solo para la hoja principal)
                if (row.temas && row.descripcionesTemas) {
                    const temasArray = row.temas.split(',').map(t => t.trim());
                    const descripcionesArray = row.descripcionesTemas.split(',').map(d => d.trim());
                    
                    row.temas = temasArray.map((nombre, index) => ({
                        nombre: nombre,
                        descripcion: descripcionesArray[index] || ''
                    }));
                }
                
                // Debug: mostrar las primeras 3 filas parseadas
                if (i <= 3) {
                    console.log(`üìÑ Fila ${i}:`, {
                        id: row.id,
                        partido: row.partido || row.nombre,
                        tema: row.tema,
                        tonoDiscursivo: row.tonoDiscursivo,
                        coherencia: row.coherencia
                    });
                }
                
                data.push(row);
            }
            
            console.log(`‚úÖ Total de registros parseados: ${data.length}`);
            return data;
        }

        // Funci√≥n auxiliar para parsear una l√≠nea CSV (maneja comillas)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Doble comilla dentro de campo entrecomillado = comilla literal
                        current += '"';
                        i++; // Saltar la siguiente comilla
                    } else {
                        // Toggle estado de comillas (no agregar las comillas al contenido)
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // Funci√≥n para cargar datos desde Google Sheets
        async function loadDataFromGoogleSheets() {
            const itemList = document.getElementById('itemList');
            const detailPanel = document.getElementById('detailPanel');
            
            // Mostrar mensaje de carga
            itemList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Cargando datos...</div>';
            detailPanel.innerHTML = '<div class="empty-state">Cargando...</div>';

            try {
                const response = await fetch(addCacheBuster(SPREADSHEET_URL));
                
                if (!response.ok) {
                    throw new Error('Error al cargar los datos');
                }
                
                const csvText = await response.text();
                allData = parseCSV(csvText);
                filteredData = allData.filter(item => item.tipo === currentTab);
                
                console.log('Datos cargados:', allData);
                
                if (allData.length === 0) {
                    itemList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No hay datos disponibles.<br><br>Verifica que tu Google Sheet est√© correctamente configurado.</div>';
                    detailPanel.innerHTML = '<div class="empty-state">No hay datos disponibles</div>';
                } else {
                    renderItems();
                    detailPanel.innerHTML = '<div class="empty-state">Selecciona un partido o candidato para ver los detalles</div>';
                }
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                itemList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #e74c3c;">
                        <p style="font-weight: bold; margin-bottom: 10px;">Error al cargar los datos</p>
                        <p style="font-size: 13px; line-height: 1.6;">
                            Verifica que:<br>
                            1. La URL del Google Sheet sea correcta<br>
                            2. El archivo est√© publicado como CSV<br>
                            3. Tengas conexi√≥n a internet
                        </p>
                    </div>
                `;
                detailPanel.innerHTML = '<div class="empty-state">Error al cargar los datos</div>';
            }
        }

        // Cambiar entre tabs
        function switchTab(tab) {
            currentTab = tab;
            
            // Actualizar UI de tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Limpiar b√∫squeda y autocompletado
            const searchInput = document.getElementById('searchInput');
            if (searchInput.value.trim().length > 0) {
                hideAutocomplete();
                updateAutocomplete();
            }
            
            // Filtrar datos seg√∫n el tab
            filterItems();
        }

        // Filtrar items por b√∫squeda
        // ============================================
        // Funciones de Autocompletado
        // ============================================
        
        let selectedSuggestionIndex = -1;
        let currentSuggestions = [];
        
        // Manejar input de b√∫squeda con autocompletado
        function handleSearchInput(event) {
            const key = event.key;
            const dropdown = document.getElementById('autocompleteDropdown');
            
            // Navegaci√≥n con teclado
            if (key === 'ArrowDown') {
                event.preventDefault();
                navigateSuggestions(1);
                return;
            } else if (key === 'ArrowUp') {
                event.preventDefault();
                navigateSuggestions(-1);
                return;
            } else if (key === 'Enter') {
                event.preventDefault();
                if (selectedSuggestionIndex >= 0 && currentSuggestions[selectedSuggestionIndex]) {
                    selectSuggestion(currentSuggestions[selectedSuggestionIndex]);
                }
                return;
            } else if (key === 'Escape') {
                hideAutocomplete();
                return;
            }
            
            // Actualizar sugerencias mientras escribe
            updateAutocomplete();
        }
        
        // Actualizar lista de sugerencias
        function updateAutocomplete() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.trim().toLowerCase();
            const dropdown = document.getElementById('autocompleteDropdown');
            
            if (searchTerm.length === 0) {
                hideAutocomplete();
                filterItems();
                return;
            }
            
            // Filtrar datos seg√∫n el tab actual
            currentSuggestions = allData.filter(item => {
                const matchesTab = item.tipo === currentTab;
                const matchesSearch = item.nombre.toLowerCase().includes(searchTerm) || 
                                     item.candidato.toLowerCase().includes(searchTerm);
                return matchesTab && matchesSearch;
            });
            
            // Renderizar sugerencias
            renderSuggestions(searchTerm);
            
            // Tambi√©n actualizar la lista lateral
            filterItems();
        }
        
        // Renderizar sugerencias en el dropdown
        function renderSuggestions(searchTerm) {
            const dropdown = document.getElementById('autocompleteDropdown');
            selectedSuggestionIndex = -1;
            
            if (currentSuggestions.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results">No se encontraron resultados</div>';
                dropdown.classList.add('show');
                return;
            }
            
            // Limitar a 8 sugerencias
            const limitedSuggestions = currentSuggestions.slice(0, 8);
            
            dropdown.innerHTML = limitedSuggestions.map((item, index) => {
                // Determinar qu√© imagen mostrar
                let imageContent;
                if (item.tipo === 'candidato') {
                    const photoUrl = item.fotoUrl || item.logoUrl;
                    if (photoUrl && photoUrl.trim() !== '') {
                        imageContent = `<img src="${photoUrl}" alt="${item.candidato || item.nombre}" onerror="this.parentElement.innerHTML='üë§';">`;
                    } else {
                        imageContent = 'üë§';
                    }
                } else {
                    if (item.logoUrl && item.logoUrl.trim() !== '') {
                        imageContent = `<img src="${item.logoUrl}" alt="${item.nombre}" onerror="this.parentElement.innerHTML='üçé';">`;
                    } else {
                        imageContent = 'üçé';
                    }
                }
                
                // Resaltar coincidencias en el texto
                const highlightText = (text, term) => {
                    if (!text) return '';
                    const regex = new RegExp(`(${term})`, 'gi');
                    return text.replace(regex, '<span class="autocomplete-highlight">$1</span>');
                };
                
                const highlightedName = highlightText(item.nombre, searchTerm);
                const highlightedCandidate = item.candidato ? highlightText(item.candidato, searchTerm) : '';
                
                return `
                    <div class="autocomplete-item" data-index="${index}" onclick="selectSuggestionByIndex(${index})">
                        <div class="autocomplete-item-icon">${imageContent}</div>
                        <div class="autocomplete-item-text">
                            <div class="autocomplete-item-name">${highlightedName}</div>
                            ${item.tipo === 'candidato' && item.candidato ? 
                                `<div class="autocomplete-item-party">${highlightedCandidate}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            dropdown.classList.add('show');
        }
        
        // Navegar entre sugerencias con teclado
        function navigateSuggestions(direction) {
            const dropdown = document.getElementById('autocompleteDropdown');
            const items = dropdown.querySelectorAll('.autocomplete-item');
            
            if (items.length === 0) return;
            
            // Remover clase active del item anterior
            if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < items.length) {
                items[selectedSuggestionIndex].classList.remove('active');
            }
            
            // Calcular nuevo √≠ndice
            selectedSuggestionIndex += direction;
            
            // Manejar l√≠mites
            if (selectedSuggestionIndex < 0) {
                selectedSuggestionIndex = items.length - 1;
            } else if (selectedSuggestionIndex >= items.length) {
                selectedSuggestionIndex = 0;
            }
            
            // Agregar clase active al nuevo item
            items[selectedSuggestionIndex].classList.add('active');
            
            // Scroll autom√°tico si es necesario
            items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
        }
        
        // Seleccionar sugerencia por √≠ndice
        function selectSuggestionByIndex(index) {
            selectSuggestion(currentSuggestions[index]);
        }
        
        // Seleccionar una sugerencia
        function selectSuggestion(item) {
            if (!item) return;
            
            // Actualizar input con el nombre seleccionado
            const searchInput = document.getElementById('searchInput');
            searchInput.value = item.nombre;
            
            // Ocultar dropdown
            hideAutocomplete();
            
            // Seleccionar el item en la lista
            selectItem(item.id);
            
            // Actualizar lista filtrada
            filterItems();
        }
        
        // Mostrar autocompletado
        function showAutocomplete() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput.value.trim().length > 0) {
                updateAutocomplete();
            }
        }
        
        // Ocultar autocompletado
        function hideAutocomplete() {
            const dropdown = document.getElementById('autocompleteDropdown');
            dropdown.classList.remove('show');
            selectedSuggestionIndex = -1;
        }
        
        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function(event) {
            const searchBox = document.querySelector('.search-box');
            if (searchBox && !searchBox.contains(event.target)) {
                hideAutocomplete();
            }
        });

        // ============================================
        // Funciones de Filtrado (actualizadas)
        // ============================================
        
        function filterItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredData = allData.filter(item => {
                const matchesTab = item.tipo === currentTab;
                const matchesSearch = item.nombre.toLowerCase().includes(searchTerm) || 
                                     item.candidato.toLowerCase().includes(searchTerm);
                return matchesTab && matchesSearch;
            });
            
            renderItems();
        }

        // Renderizar lista de items
        function renderItems() {
            const itemList = document.getElementById('itemList');
            
            if (filteredData.length === 0) {
                itemList.innerHTML = '<div class="no-results">No se encontraron resultados</div>';
                return;
            }
            
            itemList.innerHTML = filteredData.map((item, index) => {
                // Determinar qu√© imagen mostrar seg√∫n el tipo
                let imageDisplay;
                
                if (item.tipo === 'candidato') {
                    // Para candidatos, mostrar la foto del candidato
                    imageDisplay = item.fotoUrl 
                        ? `<img src="${item.fotoUrl}" alt="${item.candidato || item.nombre}" 
                               style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;"
                               onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#ccc;\\'><div style=\\'width:20px; height:20px; border-radius:50%; background:#e0e0e0; margin-bottom:4px;\\'></div><div style=\\'width:30px; height:30px; border-radius:6px; background:#e0e0e0;\\'></div></div>\\';">` 
                        : '<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#ccc;"><div style="width:20px; height:20px; border-radius:50%; background:#e0e0e0; margin-bottom:4px;"></div><div style="width:30px; height:30px; border-radius:6px; background:#e0e0e0;"></div></div>';
                } else {
                    // Para partidos, mostrar el logo del partido
                    imageDisplay = item.logoUrl 
                        ? `<img src="${item.logoUrl}" alt="${item.nombre}" 
                               style="width: 100%; height: 100%; object-fit: contain; border-radius: 6px;"
                               onerror="this.style.display='none'; this.parentElement.innerHTML='üçé';">` 
                        : 'üçé';
                }
                
                return `
                    <div class="party-item" data-id="${item.id}" data-index="${index}">
                        <div class="party-icon">${imageDisplay}</div>
                        <div class="party-name">${item.nombre}</div>
                    </div>
                `;
            }).join('');
            
            // Agregar event listeners despu√©s de renderizar
            document.querySelectorAll('.party-item').forEach(element => {
                element.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    selectItem(itemId, this);
                });
            });
        }

        // Seleccionar un item
        function selectItem(id, element) {
            const item = allData.find(i => i.id == id);
            
            if (!item) {
                console.error('Item no encontrado:', id);
                return;
            }
            
            // Actualizar UI de selecci√≥n
            document.querySelectorAll('.party-item').forEach(el => el.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            // Renderizar detalles
            renderDetails(item);
        }

        // Renderizar panel de detalles
        function renderDetails(item) {
            const detailPanel = document.getElementById('detailPanel');
            
            console.log('Renderizando detalles para:', item);
            
            // Validar que temas sea un array
            const temas = Array.isArray(item.temas) ? item.temas : [];
            
            const topicsHTML = temas.map(tema => `
                <div class="topic-tag">
                    ${tema.nombre}
                    <div class="info-icon">i</div>
                    <div class="tooltip">${tema.descripcion}</div>
                </div>
            `).join('');
            
            // Determinar si mostrar foto o avatar gen√©rico
            const avatarHTML = item.fotoUrl 
                ? `<img src="${item.fotoUrl}" alt="${item.candidato}" 
                       style="width: 100%; height: 100%;"
                       onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'avatar-icon\\'></div><div class=\\'avatar-body\\'></div>';">` 
                : `<div class="avatar-icon"></div><div class="avatar-body"></div>`;
            
            // Preparar el bot√≥n de descarga
            const downloadButton = item.planUrl 
                ? `<a href="${item.planUrl}" target="_blank" class="btn btn-primary" style="text-decoration: none;">Descarga el plan</a>`
                : `<button class="btn btn-primary" disabled style="opacity: 0.5; cursor: not-allowed;">Plan no disponible</button>`;
            
            detailPanel.innerHTML = `
                <div class="candidate-profile">
                    <div class="box-main-avatar">
                        <div class="avatar">
                            ${avatarHTML}
                        </div>
                        <div class="candidate-name">${item.candidato || 'Sin informaci√≥n'}</div>
                        <div class="party-label">${item.nombrePartido || 'Sin informaci√≥n'}</div>
                    </div>   
                    <div class="box-main-buttons">
                        <div class="action-buttons">
                            ${downloadButton}
                            <button class="btn btn-secondary" onclick="addToCompare(${JSON.stringify(item).replace(/"/g, '&quot;')})">Comparar</button>
                        </div>
                    </div>  
                    <div class="vision-section">
                        <p class="vision-text">${item.vision || 'Sin informaci√≥n de visi√≥n disponible.'}</p>    
                    </div>
                    <div class="candidate-temas-mencionados">
                        <h6>Temas m√°s mencionados:</h6>
                        <div class="topics">
                            ${topicsHTML || '<p style="color: #999;">No hay temas disponibles</p>'}
                        </div>
                    </div>
                    <div class="candidate-info">
                        <div class="box-edad">  
                            <h6>edad:</h6>                                           
                            ${item.edad ? '' + item.edad : ''}
                        </div>
                        <div class="box-departamento">
                            <h6>departamento:</h6>         
                            ${item.ubicacion || ''}
                        </div> 
                    </div>
                    <div class="candidate-experiencia">
                        <h6>Experiencia laboral:</h6>
                        <p>${item.experienciaLaboral || 'Sin informaci√≥n de experiencia disponible.'}</p>
                    </div>
                    <div class="candidate-profesion">
                        <h6>Profesi√≥n:</h6>
                        <p>${item.profesion || ''} </p>
                    </div>
                    <div class="candidate-sentencias">
                        <h6>Sentencias:</h6>
                        <p>${item.sentencias || ''} </p>
                    </div>
                    <div class="candidate-ingresos">
                        <h6>Ingresos declarados:</h6>
                        <p>${item.ingresosDeclarados || ''} </p>
                    </div>
                    
                </div>  
                
            `;
        }

        // Funci√≥n para scroll a la secci√≥n de comparar (implementar despu√©s)
        function scrollToCompare() {
            const comparisonSection = document.getElementById('comparisonSection');
            if (comparisonSection) {
                comparisonSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Iniciar la aplicaci√≥n cuando se carga la p√°gina
        window.onload = init;
    </script>

    <!-- factchecking -->
    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        
        // URL de tu Google Spreadsheet (Hoja de FactChecking)
        const FACTCHECKING_SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/1IV5othVVZ0udcHWXN5Tfv5UDsDRPjHcJDz4X6BWGiV8/export?format=csv';
        
        // Variables globales
        let factcheckingData = [];
        let filteredFactcheckingData = [];
        let currentFactcheckingFilter = 'partido';
        let factcheckingSuggestions = [];
        let selectedFactcheckingSuggestionIndex = -1;
        
        // Paginaci√≥n responsive
        const ITEMS_DESKTOP = 8; // 2 filas de 4 cards en desktop
        const ITEMS_MOBILE = 3;  // 3 cards en m√≥vil
        const MOBILE_BREAKPOINT = 768;
        
        // Estado inicial: no mostrar cards hasta que se busque
        let hasSearched = false;
        
        function getItemsPerPage() {
            return window.innerWidth <= MOBILE_BREAKPOINT ? ITEMS_MOBILE : ITEMS_DESKTOP;
        }
        
        let visibleItems = getItemsPerPage();
        
        // Actualizar al cambiar tama√±o de ventana
        window.addEventListener('resize', function() {
            const newItemsPerPage = getItemsPerPage();
            // Solo resetear si cambiamos entre m√≥vil y desktop
            if ((visibleItems <= ITEMS_MOBILE && newItemsPerPage > ITEMS_MOBILE) ||
                (visibleItems > ITEMS_MOBILE && newItemsPerPage <= ITEMS_MOBILE)) {
                visibleItems = newItemsPerPage;
                if (hasSearched) {
                    renderFactcheckingCards();
                }
            }
        });

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            loadFactcheckingData();
            
            // Cerrar autocomplete al hacer click fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.factchecking-search-box')) {
                    hideFactcheckingAutocomplete();
                }
            });
        });

        // ============================================
        // CARGAR DATOS DESDE GOOGLE SHEETS O CSV LOCAL
        // ============================================
        
        async function loadFactcheckingData() {
            const loading = document.getElementById('factcheckingLoading');
            const grid = document.getElementById('factcheckingGrid');
            
            loading.style.display = 'block';
            grid.style.display = 'none';
            
            try {
                // Agregar timestamp para evitar cach√© (solo para URLs de Google)
                let url = FACTCHECKING_SPREADSHEET_URL;
                if (url.includes('docs.google.com')) {
                    const timestamp = new Date().getTime();
                    url = url + '&_t=' + timestamp;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Error en la respuesta: ' + response.status);
                }
                
                const csvText = await response.text();
                
                // Parsear CSV
                factcheckingData = parseFactcheckingCSV(csvText);
                filteredFactcheckingData = [...factcheckingData];
                
                console.log('üìä Datos de factchecking cargados:', factcheckingData.length, 'items');
                
                // Mostrar primera fila para debug
                if (factcheckingData.length > 0) {
                    console.log('üìÑ Primera fila:', factcheckingData[0]);
                }
                
                loading.style.display = 'none';
                grid.style.display = 'grid';
                
                renderFactcheckingCards();
                
            } catch (error) {
                console.error('Error cargando datos de factchecking:', error);
                console.log('‚ö†Ô∏è Cargando datos de ejemplo...');
                
                // Cargar datos de ejemplo para demostraci√≥n
                loadExampleFactcheckingData();
            }
        }

        // Parsear CSV completo (maneja saltos de l√≠nea dentro de celdas)
        function parseFactcheckingCSV(csvText) {
            const rows = parseCSVComplete(csvText);
            
            if (rows.length === 0) return [];
            
            const headers = rows[0].map(h => h.trim().toLowerCase());
            const data = [];
            
            console.log('Headers encontrados:', headers);
            
            for (let i = 1; i < rows.length; i++) {
                const values = rows[i];
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].trim() : '';
                });
                
                // Solo agregar si tiene datos v√°lidos (al menos partido o frase)
                if (row.partido || row.frase) {
                    data.push(row);
                }
            }
            
            console.log('üìä Filas parseadas:', data.length);
            return data;
        }

        // Parser CSV completo que maneja saltos de l√≠nea dentro de celdas con comillas
        function parseCSVComplete(csvText) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;
            
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Comilla escapada ("")
                        currentCell += '"';
                        i++; // Saltar la siguiente comilla
                    } else {
                        // Toggle estado de comillas
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Fin de celda
                    currentRow.push(currentCell);
                    currentCell = '';
                } else if ((char === '\n' || (char === '\r' && nextChar === '\n')) && !inQuotes) {
                    // Fin de fila (solo si no estamos dentro de comillas)
                    currentRow.push(currentCell);
                    if (currentRow.some(cell => cell.trim() !== '')) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentCell = '';
                    if (char === '\r') i++; // Saltar \n si era \r\n
                } else if (char === '\r' && !inQuotes) {
                    // Fin de fila (solo \r)
                    currentRow.push(currentCell);
                    if (currentRow.some(cell => cell.trim() !== '')) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }
            
            // Agregar √∫ltima celda y fila si existen
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell);
                if (currentRow.some(cell => cell.trim() !== '')) {
                    rows.push(currentRow);
                }
            }
            
            return rows;
        }

        // Datos de ejemplo para demostraci√≥n
        function loadExampleFactcheckingData() {
            factcheckingData = [
                {
                    partido: 'Per√∫ Patria Segura',
                    candidato: 'Rafael Santos',
                    frase: 'Aumentar el presupuesto en salud en un 20% durante el primer a√±o de gobierno.',
                    veredicto: 'Indeterminado',
                    justificacion: 'La afirmaci√≥n sobre aumentar el presupuesto en salud en un 20% no puede ser verificada ya que no se ha publicado un presupuesto espec√≠fico para el primer a√±o de gobierno de Per√∫ Patria Segura. Adem√°s, los presupuestos anuales son aprobados por el Congreso y pueden variar seg√∫n las prioridades del gobierno en el momento de su implementaci√≥n.',
                    fuentes_consultadas: 'Ministerio de Econom√≠a y Finanzas\nhttps://www.mef.gob.pe\nInstituto Nacional de Estad√≠stica e Inform√°tica\nhttps://www.gob.pe/inei/'
                },
                {
                    partido: 'Per√∫ Patria Segura',
                    candidato: 'Rafael Santos',
                    frase: 'Construir 100 nuevas escuelas en zonas rurales en los primeros dos a√±os.',
                    veredicto: 'Indeterminado',
                    justificacion: 'La afirmaci√≥n sobre la construcci√≥n de 100 nuevas escuelas en zonas rurales carece de datos verificables espec√≠ficos que confirmen o desmientan la promesa.',
                    fuentes_consultadas: 'Ministerio de Educaci√≥n\nhttps://www.minedu.gob.pe\nInstituto Nacional de Estad√≠stica e Inform√°tica\nhttps://www.gob.pe/inei/'
                },
                {
                    partido: 'Per√∫ Patria Segura',
                    candidato: 'Rafael Santos',
                    frase: 'Reducir la tasa de criminalidad en un 30% en los primeros cuatro a√±os.',
                    veredicto: 'Indeterminado',
                    justificacion: 'La afirmaci√≥n sobre la reducci√≥n de la tasa de criminalidad en un 30% en un plazo espec√≠fico no puede ser verificada en este momento.',
                    fuentes_consultadas: 'Ministerio del Interior\nhttps://www.gob.pe/mininter\nObservatorio Nacional de Seguridad Ciudadana\nhttps://www.gob.pe/observatorio-seguridad'
                },
                {
                    partido: 'Partido Nacionalista Peruano',
                    candidato: 'Ollanta Humala',
                    frase: 'Aumentar el presupuesto en salud en un 20% en los pr√≥ximos tres a√±os.',
                    veredicto: 'Indeterminado',
                    justificacion: 'La afirmaci√≥n sobre aumentar el presupuesto en salud en un 20% no puede ser verificada actualmente.',
                    fuentes_consultadas: 'Ministerio de Econom√≠a y Finanzas\nhttps://www.gob.pe/mef\nInstituto Nacional de Estad√≠stica e Inform√°tica\nhttps://www.inei.gob.pe'
                },
                {
                    partido: 'Partido Nacionalista Peruano',
                    candidato: 'Ollanta Humala',
                    frase: 'Reducir la pobreza en un 10% durante el primer a√±o de gobierno.',
                    veredicto: 'Indeterminado',
                    justificacion: 'La afirmaci√≥n de reducir la pobreza en un 10% en el primer a√±o de gobierno es ambiciosa y depende de m√∫ltiples factores econ√≥micos y sociales.',
                    fuentes_consultadas: 'Instituto Nacional de Estad√≠stica e Inform√°tica\nhttps://www.gob.pe/inei/\nMinisterio de Econom√≠a y Finanzas\nhttps://www.mef.gob.pe'
                },
                {
                    partido: 'Avanza Pa√≠s',
                    candidato: 'Phillip Butters',
                    frase: 'Aumentar el presupuesto en educaci√≥n en un 20% en los pr√≥ximos dos a√±os.',
                    veredicto: 'Indeterminado',
                    justificacion: 'La afirmaci√≥n de aumentar el presupuesto en educaci√≥n en un 20% no puede ser verificada actualmente.',
                    fuentes_consultadas: 'Ministerio de Educaci√≥n\nhttps://www.minedu.gob.pe\nMinisterio de Econom√≠a y Finanzas\nhttps://www.mef.gob.pe'
                },
                {
                    partido: 'Frente Amplio',
                    candidato: 'Marco Arana Zegarra',
                    frase: 'Aumentar el salario m√≠nimo a S/ 1,500 en el primer a√±o de gobierno.',
                    veredicto: 'Indeterminado',
                    justificacion: 'La afirmaci√≥n sobre el aumento del salario m√≠nimo a S/ 1,500 es indeterminada porque no se ha establecido oficialmente un plan de implementaci√≥n.',
                    fuentes_consultadas: 'Ministerio de Trabajo y Promoci√≥n del Empleo\nhttps://www.gob.pe/mtpe\nDiario El Comercio\nhttps://elcomercio.pe/'
                },
                {
                    partido: 'Fuerza Popular',
                    candidato: 'Keiko Fujimori',
                    frase: 'Crear 2 millones de empleos formales en el quinquenio.',
                    veredicto: 'Enga√±osa',
                    justificacion: 'La propuesta no especifica los mecanismos concretos para la creaci√≥n de estos empleos ni c√≥mo se financiar√≠a.',
                    fuentes_consultadas: 'Ministerio de Trabajo\nhttps://www.gob.pe/mtpe'
                }
            ];
            
            filteredFactcheckingData = [...factcheckingData];
            
            document.getElementById('factcheckingLoading').style.display = 'none';
            document.getElementById('factcheckingGrid').style.display = 'grid';
            
            console.log('üìä Datos de ejemplo cargados:', factcheckingData.length, 'items');
            
            resetPagination();
            renderFactcheckingCards();
        }

        // ============================================
        // RENDERIZAR CARDS
        // ============================================
        
        function renderFactcheckingCards() {
            const grid = document.getElementById('factcheckingGrid');
            const noResults = document.getElementById('factcheckingNoResults');
            const loadMoreContainer = document.getElementById('factcheckingLoadMore');
            const loadMoreCount = document.getElementById('loadMoreCount');
            const initialState = document.getElementById('factcheckingInitial');
            
            // Si no se ha buscado, mostrar estado inicial
            if (!hasSearched) {
                grid.style.display = 'none';
                noResults.style.display = 'none';
                loadMoreContainer.style.display = 'none';
                initialState.style.display = 'block';
                return;
            }
            
            // Ocultar estado inicial
            initialState.style.display = 'none';
            
            if (filteredFactcheckingData.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
                loadMoreContainer.style.display = 'none';
                return;
            }
            
            grid.style.display = 'grid';
            noResults.style.display = 'none';
            
            // Mostrar solo los items visibles
            const itemsToShow = filteredFactcheckingData.slice(0, visibleItems);
            grid.innerHTML = itemsToShow.map(item => createFactcheckingCard(item)).join('');
            
            // Mostrar/ocultar bot√≥n "ver m√°s"
            const remainingItems = filteredFactcheckingData.length - visibleItems;
            
            if (remainingItems > 0) {
                loadMoreContainer.style.display = 'flex';
                loadMoreCount.textContent = `Mostrando ${visibleItems} de ${filteredFactcheckingData.length} resultados`;
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }
        
        // Cargar m√°s items
        function loadMoreFactchecking() {
            visibleItems += getItemsPerPage();
            renderFactcheckingCards();
            
            // Scroll suave hacia los nuevos items
            const grid = document.getElementById('factcheckingGrid');
            const cards = grid.querySelectorAll('.factchecking-card');
            const itemsPerPage = getItemsPerPage();
            if (cards.length > visibleItems - itemsPerPage) {
                const targetCard = cards[visibleItems - itemsPerPage];
                targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Resetear paginaci√≥n (cuando se cambia de tab o se busca)
        function resetPagination() {
            visibleItems = getItemsPerPage();
        }

        function createFactcheckingCard(item) {
            // Normalizar veredicto
            const veredicto = normalizeVeredicto(item.veredicto);
            const veredictoClass = getVeredictoClass(veredicto);
            
            // Formatear fuentes
            const fuentes = formatFuentes(item.fuentes_consultadas);
            
            return `
                <div class="factchecking-card">
                    <div class="factchecking-card-header">
                        <h3>${item.partido || 'Partido'}</h3>
                        <p class="factchecking-card-intro">${item.candidato || 'Candidato'}</p>
                    </div>
                    <div class="factchecking-card-body">
                        <div class="factchecking-frase">
                            "${item.frase || 'Frase no disponible'}"
                        </div>
                        
                        <div class="factchecking-veredicto ${veredictoClass}">
                            <div class="factchecking-veredicto-label">${veredicto}</div>
                            <div class="factchecking-veredicto-text">
                                ${item.justificacion || 'Justificaci√≥n no disponible'}
                            </div>
                        </div>
                        
                        <div class="factchecking-fuentes">
                            <strong>Fuente:</strong> ${fuentes}
                        </div>
                    </div>
                </div>
            `;
        }

        function normalizeVeredicto(veredicto) {
            if (!veredicto) return 'INDETERMINADO';
            const v = veredicto.toLowerCase().trim();
            if (v.includes('verdad')) return 'VERDADERA';
            if (v.includes('fals')) return 'FALSA';
            if (v.includes('enga√±') || v.includes('engan')) return 'ENGA√ëOSA';
            return 'INDETERMINADO';
        }

        function getVeredictoClass(veredicto) {
            const v = veredicto.toLowerCase();
            if (v.includes('verdad')) return 'verdadera';
            if (v.includes('fals')) return 'falsa';
            if (v.includes('enga√±') || v.includes('engan')) return 'enganosa';
            return 'indeterminado';
        }

        function formatFuentes(fuentes) {
            if (!fuentes) return 'No especificada';
            
            // Normalizar saltos de l√≠nea (pueden venir como \n literal o como salto real)
            let normalizedFuentes = fuentes
                .replace(/\\n/g, '\n')  // Convertir \n literal a salto real
                .replace(/\r\n/g, '\n') // Normalizar Windows line endings
                .replace(/\r/g, '\n');  // Normalizar old Mac line endings
            
            // Detectar URLs y convertirlas en links
            const lines = normalizedFuentes.split('\n');
            const formattedParts = [];
            let currentSource = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                if (line.startsWith('http')) {
                    // Es una URL, crear link con el nombre anterior si existe
                    const domain = extractDomain(line);
                    if (currentSource) {
                        formattedParts.push(`<a href="${line}" target="_blank" rel="noopener">${currentSource}</a>`);
                        currentSource = '';
                    } else {
                        formattedParts.push(`<a href="${line}" target="_blank" rel="noopener">${domain}</a>`);
                    }
                } else {
                    // Es el nombre de una fuente, guardarlo para asociar con la URL siguiente
                    if (currentSource) {
                        // Si ya hab√≠a un nombre sin URL, agregarlo solo
                        formattedParts.push(currentSource);
                    }
                    currentSource = line;
                }
            }
            
            // Si qued√≥ un nombre sin URL al final
            if (currentSource) {
                formattedParts.push(currentSource);
            }
            
            return formattedParts.length > 0 ? formattedParts.join(' | ') : 'No especificada';
        }

        function extractDomain(url) {
            try {
                const domain = new URL(url).hostname;
                return domain.replace('www.', '');
            } catch {
                return url;
            }
        }

        // ============================================
        // TABS DE FILTRO
        // ============================================
        
        function switchFactcheckingTab(filter) {
            // Actualizar tabs activos
            document.querySelectorAll('.factchecking-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.filter === filter) {
                    tab.classList.add('active');
                }
            });
            
            currentFactcheckingFilter = filter;
            
            // Mostrar/ocultar el input de b√∫squeda o el dropdown seg√∫n el filtro
            const searchContainer = document.getElementById('factcheckingSearchContainer');
            const dropdownContainer = document.getElementById('factcheckingDropdownContainer');
            const searchInput = document.getElementById('factcheckingSearchInput');
            const dropdown = document.getElementById('factcheckingVeredictoDropdown');
            
            if (filter === 'veredicto') {
                // Mostrar dropdown, ocultar input de b√∫squeda
                searchContainer.style.display = 'none';
                dropdownContainer.style.display = 'block';
                dropdown.value = ''; // Resetear selecci√≥n
            } else {
                // Mostrar input de b√∫squeda, ocultar dropdown
                searchContainer.style.display = 'block';
                dropdownContainer.style.display = 'none';
                searchInput.value = '';
                searchInput.placeholder = getPlaceholder(filter);
            }
            
            // Resetear datos filtrados
            filteredFactcheckingData = [...factcheckingData];
            renderFactcheckingCards();
            hideFactcheckingAutocomplete();
        }

        function getPlaceholder(filter) {
            switch(filter) {
                case 'partido': return 'Buscar partido...';
                case 'candidato': return 'Buscar candidato...';
                default: return 'Buscar...';
            }
        }

        // ============================================
        // MANEJO DEL DROPDOWN DE VEREDICTO
        // ============================================
        
        function handleVeredictoChange() {
            const dropdown = document.getElementById('factcheckingVeredictoDropdown');
            const selectedValue = dropdown.value;
            
            // Marcar que se ha realizado b√∫squeda para mostrar las cards
            hasSearched = true;
            
            if (!selectedValue) {
                // Si no hay selecci√≥n, mostrar todos
                filteredFactcheckingData = [...factcheckingData];
            } else {
                // Filtrar por el veredicto seleccionado
                filteredFactcheckingData = factcheckingData.filter(item => {
                    const veredictoClass = getVeredictoClass(item.veredicto);
                    return veredictoClass === selectedValue;
                });
            }
            
            resetPagination();
            renderFactcheckingCards();
        }

        // ============================================
        // B√öSQUEDA Y AUTOCOMPLETE (para partido y candidato)
        // ============================================
        
        function handleFactcheckingSearch(event) {
            const searchTerm = event.target.value.toLowerCase().trim();
            
            // Manejar navegaci√≥n con teclado
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                navigateFactcheckingSuggestions(1);
                return;
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                navigateFactcheckingSuggestions(-1);
                return;
            } else if (event.key === 'Enter') {
                event.preventDefault();
                selectFactcheckingHighlightedItem();
                return;
            } else if (event.key === 'Escape') {
                hideFactcheckingAutocomplete();
                return;
            }
            
            // Si est√° vac√≠o, mostrar todos
            if (!searchTerm) {
                filteredFactcheckingData = [...factcheckingData];
                renderFactcheckingCards();
                hideFactcheckingAutocomplete();
                return;
            }
            
            // Generar sugerencias
            updateFactcheckingAutocomplete(searchTerm);
        }
        
        // Seleccionar el item resaltado con Enter
        function selectFactcheckingHighlightedItem() {
            if (selectedFactcheckingSuggestionIndex >= 0 && selectedFactcheckingSuggestionIndex < factcheckingSuggestions.length) {
                selectFactcheckingSuggestion(factcheckingSuggestions[selectedFactcheckingSuggestionIndex]);
            }
        }

        function updateFactcheckingAutocomplete(searchTerm) {
            const suggestions = new Set();
            
            factcheckingData.forEach(item => {
                let value = '';
                
                switch(currentFactcheckingFilter) {
                    case 'partido':
                        value = item.partido || '';
                        break;
                    case 'candidato':
                        value = item.candidato || '';
                        break;
                    case 'veredicto':
                        value = item.veredicto || '';
                        break;
                }
                
                if (value.toLowerCase().includes(searchTerm)) {
                    suggestions.add(JSON.stringify({
                        value: value,
                        type: currentFactcheckingFilter,
                        partido: item.partido,
                        candidato: item.candidato
                    }));
                }
            });
            
            // Convertir a array y parsear JSON
            factcheckingSuggestions = Array.from(suggestions).map(s => JSON.parse(s));
            selectedFactcheckingSuggestionIndex = -1;
            
            renderFactcheckingSuggestions(searchTerm);
        }

        function renderFactcheckingSuggestions(searchTerm) {
            const autocomplete = document.getElementById('factcheckingAutocomplete');
            
            if (factcheckingSuggestions.length === 0) {
                autocomplete.innerHTML = '<div class="factchecking-autocomplete-item" style="cursor: default;">No se encontraron resultados</div>';
                autocomplete.classList.add('show');
                return;
            }
            
            autocomplete.innerHTML = factcheckingSuggestions.slice(0, 8).map((item, index) => {
                // Resaltar coincidencias
                const highlightedValue = highlightMatch(item.value, searchTerm);
                
                // Determinar icono/badge seg√∫n tipo
                let iconContent = '';
                if (item.type === 'veredicto') {
                    const veredictoClass = getVeredictoClass(item.value);
                    iconContent = `<span class="veredicto-badge ${veredictoClass}">${normalizeVeredicto(item.value)}</span>`;
                } else {
                    iconContent = item.type === 'candidato' ? 'üë§' : 'üèõÔ∏è';
                }
                
                // Subtexto
                let subText = '';
                if (item.type === 'candidato') {
                    subText = item.partido || '';
                } else if (item.type === 'partido') {
                    subText = item.candidato || '';
                }
                
                return `
                    <div class="factchecking-autocomplete-item" 
                         data-index="${index}" 
                         onclick="selectFactcheckingSuggestionByIndex(${index})">
                        <div class="item-icon">${iconContent}</div>
                        <div class="item-text">
                            <div class="item-name">${highlightedValue}</div>
                            ${subText ? `<div class="item-sub">${subText}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            autocomplete.classList.add('show');
        }

        function highlightMatch(text, term) {
            if (!text) return '';
            const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function navigateFactcheckingSuggestions(direction) {
            const items = document.querySelectorAll('.factchecking-autocomplete-item[data-index]');
            if (items.length === 0) return;
            
            // Remover active del anterior
            if (selectedFactcheckingSuggestionIndex >= 0 && selectedFactcheckingSuggestionIndex < items.length) {
                items[selectedFactcheckingSuggestionIndex].classList.remove('active');
            }
            
            // Calcular nuevo √≠ndice
            selectedFactcheckingSuggestionIndex += direction;
            
            if (selectedFactcheckingSuggestionIndex < 0) {
                selectedFactcheckingSuggestionIndex = items.length - 1;
            } else if (selectedFactcheckingSuggestionIndex >= items.length) {
                selectedFactcheckingSuggestionIndex = 0;
            }
            
            // Agregar active al nuevo
            items[selectedFactcheckingSuggestionIndex].classList.add('active');
            items[selectedFactcheckingSuggestionIndex].scrollIntoView({ block: 'nearest' });
        }

        function selectFactcheckingSuggestionByIndex(index) {
            selectFactcheckingSuggestion(factcheckingSuggestions[index]);
        }

        function selectFactcheckingSuggestion(suggestion) {
            if (!suggestion) return;
            
            const searchInput = document.getElementById('factcheckingSearchInput');
            searchInput.value = suggestion.value;
            
            // Marcar que se ha realizado b√∫squeda
            hasSearched = true;
            
            // Filtrar datos
            filteredFactcheckingData = factcheckingData.filter(item => {
                switch(currentFactcheckingFilter) {
                    case 'partido':
                        return (item.partido || '').toLowerCase() === suggestion.value.toLowerCase();
                    case 'candidato':
                        return (item.candidato || '').toLowerCase() === suggestion.value.toLowerCase();
                    case 'veredicto':
                        return normalizeVeredicto(item.veredicto) === normalizeVeredicto(suggestion.value);
                    default:
                        return true;
                }
            });
            
            resetPagination();
            renderFactcheckingCards();
            hideFactcheckingAutocomplete();
        }

        function showFactcheckingAutocomplete() {
            const searchInput = document.getElementById('factcheckingSearchInput');
            if (searchInput.value.trim().length > 0) {
                updateFactcheckingAutocomplete(searchInput.value.toLowerCase().trim());
            }
        }

        function hideFactcheckingAutocomplete() {
            document.getElementById('factcheckingAutocomplete').classList.remove('show');
            selectedFactcheckingSuggestionIndex = -1;
        }

        // Cerrar autocomplete al hacer click fuera
        document.addEventListener('click', function(event) {
            const searchBox = document.querySelector('.factchecking-search-box');
            if (searchBox && !searchBox.contains(event.target)) {
                hideFactcheckingAutocomplete();
            }
        });
    </script>
   
   
</body>
</html>
